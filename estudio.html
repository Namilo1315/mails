
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>Hugo Alonso Batistini — Gestión Jurídica & PDF Único</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{
    --bg:#f6f8fb; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb;
    --primary:#0f3d73; --primary-2:#174a8b;
    --accent:#b88a28; --accent-2:#0ea5e9;
    --focus:#93c5fd;
    --ok:#16a34a; --warn:#d97706; --err:#dc2626;
    --shadow:0 8px 24px rgba(15,61,115,.08);
    --shadow-2:0 14px 36px rgba(15,61,115,.16);
  }
  *{box-sizing:border-box}
  html,body{height:100%;max-width:100%;overflow-x:hidden}
  body{
    margin:0;background:linear-gradient(180deg,#f9fafb,#f6f8fb 40%);
    color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
    -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent;
  }
  img,canvas{max-width:100%}

  /* Topbar */
  .topbar{position:sticky;top:0;z-index:70;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--border)}
  .topbar .wrap{display:flex;flex-wrap:wrap;align-items:center;gap:12px;padding:10px 16px;max-width:1200px;margin:0 auto}
  .logo{width:42px;height:42px;border-radius:999px;border:2px solid var(--primary);display:grid;place-items:center;font-weight:800;color:var(--primary);box-shadow:var(--shadow);overflow:hidden;background:#fff}
  .brand{font-weight:700;letter-spacing:.2px}
  .brand small{display:block;color:var(--muted);font-weight:500;font-size:12px;margin-top:-2px}

  /* Firma chip */
  .sig-chip{margin-left:auto;display:flex;align-items:center;gap:10px}
  .chip{display:flex;align-items:center;gap:8px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 10px;box-shadow:var(--shadow)}
  .chip .mini{width:64px;height:26px;border:1px solid var(--border);border-radius:6px;background:#fff;background-size:contain;background-position:center;background-repeat:no-repeat}
  .chip .txt{font-size:12px;color:var(--muted)}
  .chip .btn{padding:6px 10px}

  /* Buscador */
  .searchbar{order:5;flex:1 0 100%;display:flex;gap:8px;align-items:center;position:relative}
  .searchbar input{flex:1;min-width:260px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
  .searchbar .results{position:absolute;top:44px;left:0;right:0;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);max-height:320px;overflow:auto;display:none}
  .searchbar .results.show{display:block}
  .result-item{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;gap:10px;cursor:pointer}
  .result-item:hover{background:#f9fafb}
  .r-avatar{width:36px;height:36px;border-radius:999px;background:#e5eef8;color:#0f3d73;display:grid;place-items:center;font-weight:700}
  .r-meta{font-size:12px;color:var(--muted)}

  /* Popover firma */
  .sig-pop{position:fixed;right:16px;top:66px;width:min(540px,92vw);z-index:80;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow-2);display:none}
  .sig-pop.show{display:block}
  .sig-pop .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 12px;border-bottom:1px solid var(--border)}
  .sig-pop .bd{padding:12px}
  .sig-pop .sig-canvas{width:100%;height:160px;border-radius:10px;border:1px solid var(--border);touch-action:none;cursor:crosshair;background:#fff}
  .sig-tools{display:flex;gap:8px;margin-top:8px}

  /* Layout */
  .wrap{max-width:1200px;margin:22px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{
    background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow);
    transition:box-shadow .2s ease, transform .15s ease;
  }
  .card:hover{box-shadow:var(--shadow-2)}
  .card h2{margin:0 0 12px;font-size:18px}
  label{display:block;font-size:13px;color:var(--muted);margin:8px 0 4px}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff;color:#000;font-size:16px;transition:box-shadow .2s ease, border-color .2s ease}
  input:focus,select:focus,textarea:focus{outline:2px solid var(--focus);outline-offset:1px; box-shadow:0 0 0 4px rgba(147,197,253,.25)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .help{font-size:12px;color:var(--muted)}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

  /* Botones (hit area completa y dinamismo) */
  .btn{
    border:1px solid var(--border);
    background:#fff;
    color:var(--text);
    padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:700;
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    min-height:44px;line-height:1.2;user-select:none;-webkit-user-select:none;
    touch-action:manipulation;-webkit-appearance:none;appearance:none;
    position:relative;
    transition:transform .06s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease, filter .2s ease;
    box-shadow:var(--shadow);
  }
  .btn:hover{box-shadow:var(--shadow-2); transform:translateY(-1px)}
  .btn:active{transform:translateY(0); filter:brightness(.98)}
  .btn:focus-visible{outline:3px solid rgba(14,165,233,.35)}
  .btn.primary{
    background:linear-gradient(135deg,var(--primary),var(--primary-2));
    border-color:transparent; color:#fff;
  }
  .btn.accent{
    background:linear-gradient(135deg,#b88a28,#d5a43a);
    border-color:transparent; color:#fff;
  }
  .btn.info{
    background:linear-gradient(135deg,#0ea5e9,#0ea5e9);
    border-color:transparent; color:#fff;
  }
  .btn.ghost{background:transparent}
  .btn.small{padding:8px 12px;font-size:12px;min-height:36px}
  .status{font-size:13px;color:var(--muted);margin-top:6px}

  /* Tabla anexos */
  .table-holder{overflow:auto;border:1px solid var(--border);border-radius:12px;margin-top:10px;max-height:42vh;background:#fff}
  table{width:100%;border-collapse:collapse;table-layout:fixed}
  th,td{border-bottom:1px solid var(--border);padding:8px 10px;font-size:13px;vertical-align:middle}
  th{background:#fafafa;text-align:left;color:#374151;position:sticky;top:0;z-index:1}
  tbody tr:hover{background:#f9fafb}
  .file-cell{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px}
  .right{text-align:right}
  .muted{color:var(--muted)}
  .actions .btn.small{padding:6px 8px}
  tbody input, tbody select{padding:6px 8px;font-size:13px}

  /* Toolbar centrada */
  .toolbar{margin-top:16px}
  .toolbar .bar{
    display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
    background:#ffffff;border:1px solid var(--border);padding:10px;border-radius:14px;box-shadow:var(--shadow)
  }

  /* Toast */
  .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);min-width:280px;background:linear-gradient(135deg,#0f3d73,#0ea5e9);color:#fff;padding:12px 16px;border-radius:14px;box-shadow:var(--shadow);font-weight:700;letter-spacing:.2px;opacity:0;transition:.25s;z-index:1000;display:flex;align-items:center;gap:10px}
  .toast.show{opacity:1}
  .toast .ico{width:18px;height:18px;display:inline-block}
  .toast.ok{background:linear-gradient(135deg,#16a34a,#0ea5e9)}
  .toast.err{background:linear-gradient(135deg,#dc2626,#0ea5e9)}

  /* Overlay expedientes (encima del topbar) */
  .overlay{position:fixed;inset:0;background:#fff;z-index:999;display:none}
  .overlay.show{display:block}
  .ov-header{display:flex;align-items:center;gap:12px;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#fff}
  .ov-header h3{margin:0;font-size:18px}
  .ov-body{height:calc(100vh - 62px);display:flex;flex-direction:column;padding:12px 16px;gap:12px}
  .ov-search{display:flex;gap:8px;flex-wrap:wrap}
  .ov-table{flex:1;overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff}
  .ov-table th, .ov-table td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:14px}
  .ov-table tr:hover{background:#f9fafb}

  /* Botón flotante de dictado por voz */
  .voice-fab{
    position:fixed; right:16px; bottom:16px; z-index:1001;
    background:linear-gradient(135deg,#ffffff,#f8fafc);
    border:1px solid var(--border); box-shadow:var(--shadow-2);
    padding:12px 16px; border-radius:999px; font-weight:800; cursor:pointer;
    transition:transform .1s ease, box-shadow .2s ease, background .2s ease;
  }
  .voice-fab:hover{ transform:translateY(-1px) }
  .voice-fab.listening{ background:linear-gradient(135deg,#0ea5e9,#38bdf8); color:#fff; border-color:#0ea5e9; box-shadow:0 14px 36px rgba(14,165,233,.35) }
  .voice-fab[hidden]{ display:none !important }

  /* ===== Móvil (≤640px) ===== */
  @media (max-width:640px){
    .topbar .wrap{padding:8px 12px;gap:8px}
    .logo{width:36px;height:36px}
    .brand small{display:none}
    .wrap{padding:0 12px}
    .row,.row3{grid-template-columns:1fr}
    .btn{min-height:48px}
    .toolbar .bar{
      position:sticky; bottom:0; z-index:65;
      border-radius:14px; padding-bottom:calc(10px + env(safe-area-inset-bottom));
      box-shadow:0 -8px 24px rgba(15,61,115,.08);
    }
    .toolbar .bar .btn{flex:1 1 calc(50% - 8px)}
    .searchbar input{font-size:16px}
    .table-holder{max-height:50vh}
    .voice-fab{ bottom:calc(86px + env(safe-area-inset-bottom)) }
  }
</style>
</head>
<body>
  <header class="topbar">
    <div class="wrap">
      <div class="logo" id="uiLogo">HAB</div>
      <div class="brand">Hugo Alonso Batistini <small>Gestión de expedientes — PDF único & Base local</small></div>

      <div class="sig-chip">
        <div id="sigChip" class="chip">
          <div class="mini" id="sigMini" title="Vista previa de firma"></div>
          <div class="txt" id="sigTxt">Sin firma</div>
          <button id="btnSigOpen" class="btn small" type="button">Cargar/Editar</button>
        </div>
      </div>

      <div class="searchbar">
        <input id="searchBox" placeholder="Buscar persona por nombre o DNI…" autocomplete="off">
        <button id="btnSearch" class="btn small info" type="button">Buscar</button>
        <div id="searchResults" class="results"></div>
      </div>
    </div>
  </header>

  <!-- Popover firma -->
  <div id="sigPop" class="sig-pop" role="dialog" aria-modal="true">
    <div class="hd">
      <strong>Firma digital del estudio</strong>
      <button id="sigClose" class="btn small" type="button">Cerrar</button>
    </div>
    <div class="bd">
      <canvas id="sigCanvas" class="sig-canvas"></canvas>
      <div class="sig-tools">
        <button id="sigClear" class="btn ghost" type="button">Limpiar</button>
        <input id="sigNombre" placeholder="Firmante (ej.: Dra. Gómez — Mat. 1234)" style="flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:10px">
        <button id="sigSave" class="btn primary" type="button">Guardar firma</button>
      </div>
      <div class="help">Al guardar se ocultará este panel. La firma se insertará en la carátula del PDF.</div>
    </div>
  </div>

  <main class="wrap">
    <div class="grid">
      <section class="card">
        <h2>1) Datos del Cliente</h2>
        <div class="row">
          <div>
            <label>Nombre y Apellido</label>
            <input id="cli_nombre" placeholder="Ej: Juan Pérez" required>
          </div>
          <div>
            <label>Contacto (solo celular con código país)</label>
            <input id="cli_contacto" placeholder="Ej: 5492615555555" inputmode="numeric" pattern="\d*" maxlength="16">
          </div>
        </div>
        <div class="row">
          <div>
            <label>DNI / CUIT (único)</label>
            <input id="cli_doc" placeholder="Ej: 30123456" required>
          </div>
          <div>
            <label>Domicilio</label>
            <input id="cli_dom" placeholder="Calle 123, Maipú, Mendoza">
          </div>
        </div>

        <h2 style="margin-top:18px">2) Datos del Expediente</h2>
        <div class="row3">
          <div>
            <label>Tipo de Demanda</label>
            <input id="exp_tipo" placeholder="Laboral / Civil / Comercial...">
          </div>
          <div>
            <label>Juzgado</label>
            <input id="exp_juzgado" placeholder="Juzgado 5º de...">
          </div>
          <div>
            <label>N° de Expediente</label>
            <input id="exp_num" placeholder="Expte. 12345/2025">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Carátula</label>
            <input id="exp_caratula" placeholder="Pérez, Juan c/ Empresa SA s/ Despido">
          </div>
          <div>
            <label>Fecha</label>
            <input id="exp_fecha" type="date">
          </div>
        </div>
        <label>Observaciones</label>
        <textarea id="exp_obs" rows="3" placeholder="Notas internas, medidas cautelares, plazos, etc."></textarea>

        <div class="actions">
          <button id="btnNuevoExp" class="btn ghost" type="button">Nuevo expediente</button>
          <button id="btnListExp" class="btn ghost" type="button">Ver expedientes guardados</button>
        </div>
        <div id="expList" class="status"></div>
      </section>

      <section class="card">
        <h2>3) Anexos del Expediente (múltiples documentos)</h2>
        <div class="actions">
          <input id="fileInput" type="file" accept=".pdf,.png,.jpg,.jpeg" multiple hidden>
          <button id="btnAddFiles" class="btn" type="button">Agregar archivos</button>
          <button id="btnClearFiles" class="btn ghost" type="button">Limpiar anexos</button>
        </div>
        <p class="help">Cargá <b>varios documentos</b> (PDF, JPG, PNG). Se unirán en un PDF con carátula e índice.</p>

        <div class="table-holder">
          <table>
            <thead>
              <tr>
                <th style="width:42px">#</th>
                <th>Título (editable)</th>
                <th>Tipo</th>
                <th>Archivo</th>
                <th class="right">Tamaño</th>
                <th style="width:200px">Acciones</th>
              </tr>
            </thead>
            <tbody id="anexosBody">
              <tr><td colspan="6" class="muted" style="text-align:center;padding:12px">Sin anexos aún</td></tr>
            </tbody>
          </table>
        </div>
        <div class="status" id="filesStatus"></div>
      </section>
    </div>

    <section class="toolbar">
      <div class="bar">
        <button id="btnGuardar" class="btn primary" type="button">Guardar expediente</button>
        <button id="btnWhatsApp" class="btn info" type="button">Enviar WhatsApp</button>
        <button id="btnGenerar" class="btn accent" type="button">Generar PDF</button>
        <button id="btnDemo" class="btn" type="button">Cargar demo</button>
        <button id="btnEliminar" class="btn" type="button" style="border-color:#fecaca;color:#b91c1c">Eliminar expediente</button>
      </div>
      <div class="status" id="status"></div>
    </section>
  </main>

  <!-- Overlay de expedientes -->
  <div id="expOverlay" class="overlay" aria-modal="true" role="dialog">
    <div class="ov-header">
      <h3>Expedientes guardados</h3>
      <div class="ov-search">
        <input id="expSearchBox" placeholder="Filtrar por nombre, DNI/CUIT, Nº expediente, carátula, juzgado, tipo…" style="flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:10px">
        <button id="expSearchBtn" class="btn info" type="button">Filtrar</button>
        <button id="expBack" class="btn" type="button">Volver al inicio</button>
      </div>
    </div>
    <div class="ov-body">
      <div class="ov-table">
        <table>
          <thead>
            <tr>
              <th style="width:180px">Persona</th>
              <th style="width:120px">DNI/CUIT</th>
              <th style="width:140px">Nº Expediente</th>
              <th>Carátula</th>
              <th style="width:120px">Tipo</th>
              <th style="width:160px">Juzgado</th>
              <th style="width:120px">Actualizado</th>
              <th style="width:80px">Abrir</th>
            </tr>
          </thead>
          <tbody id="expTableBody">
            <tr><td colspan="8" class="muted" style="text-align:center;padding:14px">No hay expedientes aún.</td></tr>
          </tbody>
        </table>
      </div>
      <div class="status" id="expCount"></div>
    </div>
  </div>

  <!-- Botón flotante de dictado por voz -->
  <button id="voiceFab" class="voice-fab" type="button" title="Dictar por voz">🎤 Dictar</button>

  <div id="toast" class="toast"><span class="ico" id="toastIco">✔</span><span id="toastTxt">Ok</span></div>

  <!-- pdf-lib (con fallback) -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script>
    /* ========== Utils ========== */
    const $ = (id)=>document.getElementById(id);
    const toast = (msg, kind='ok')=>{
      const t=$('toast'), ico=$('toastIco'), txt=$('toastTxt');
      t.classList.remove('ok','err'); t.classList.add(kind==='ok'?'ok':(kind==='err'?'err':'')); 
      ico.textContent = kind==='ok'?'✔':(kind==='err'?'✖':'ℹ');
      txt.textContent=msg; t.classList.add('show');
      clearTimeout(t._h); t._h=setTimeout(()=>t.classList.remove('show'),2400);
    };
    const escapeHtml=s=> (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    async function ensurePdfLib(){
      if (window.PDFLib) return;
      await new Promise((resolve,reject)=>{
        const s1=document.createElement('script');
        s1.src='https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js';
        s1.onload=resolve; s1.onerror=reject; document.head.appendChild(s1);
      });
      if(!window.PDFLib) throw new Error('No se pudo cargar pdf-lib');
    }

    /* ========== Estado / DB ========== */
    const state = { anexos: [], currentExpId: null, currentPersonaId: null, signatureDataUrl: null, signatureName: '' };

    const dbp = new Promise((resolve,reject)=>{
      const req = indexedDB.open('jab_db', 7);
      req.onupgradeneeded = ()=>{
        const db = req.result;
        if(!db.objectStoreNames.contains('personas')){
          const p = db.createObjectStore('personas', { keyPath:'id' });
          p.createIndex('doc','doc',{unique:true});
          p.createIndex('nombreLower','nombreLower',{unique:false});
        }
        if(!db.objectStoreNames.contains('expedientes')){
          const ex = db.createObjectStore('expedientes', { keyPath:'id' });
          ex.createIndex('personaId','personaId',{unique:false});
          ex.createIndex('updatedAt','updatedAt',{unique:false});
        }
      };
      req.onsuccess=()=>resolve(req.result);
      req.onerror=()=>reject(req.error);
    });

    const withStore = async (name, mode, work)=> new Promise(async (res,rej)=>{
      const db = await dbp;
      const tx = db.transaction(name, mode);
      const store = tx.objectStore(name);
      work(store, tx);
      tx.oncomplete = ()=>res(true);
      tx.onerror = ()=>rej(tx.error);
    });
    const idbPut = (name, val)=> withStore(name,'readwrite', s=>{ s.put(val); });
    const idbDel = (name, key)=> withStore(name,'readwrite', s=>{ s.delete(key); });
    const idbGet = (name, key)=> new Promise(async (res,rej)=>{
      const db = await dbp; const tx = db.transaction(name,'readonly'); const s = tx.objectStore(name);
      const r = s.get(key); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error);
    });
    const idbGetAll = (name)=> new Promise(async (res,rej)=>{
      const db = await dbp; const tx = db.transaction(name,'readonly'); const s = tx.objectStore(name);
      const r = s.getAll ? s.getAll() : s.openCursor();
      if (s.getAll){ r.onsuccess=()=>res(r.result||[]); r.onerror=()=>rej(r.error); }
      else {
        const out=[]; r.onsuccess=()=>{const c=r.result; if(c){ out.push(c.value); c.continue(); } else res(out); };
      }
    });

    const savePersona = async (persona)=> idbPut('personas', persona);
    const getPersonaById = async (id)=> idbGet('personas', id);
    const searchPersonas = async (q)=>{
      q=(q||'').trim().toLowerCase(); if(!q) return [];
      const all=await idbGetAll('personas');
      return all.filter(p=> (p.doc||'').toLowerCase().includes(q) || (p.nombreLower||'').includes(q)).slice(0,200);
    };

    const saveExpediente = async (exp)=> idbPut('expedientes', exp);
    const getExpedientesByPersona = async (personaId)=>{
      const all = await idbGetAll('expedientes');
      return all.filter(e=> e.personaId===personaId);
    };
    const getExpedienteById = async (id)=> idbGet('expedientes', id);
    const getAllExpedientes = async ()=> idbGetAll('expedientes');
    const deleteExpediente = async (id)=> idbDel('expedientes', id);

    /* ========== Archivos / Anexos ========== */
    $('btnAddFiles').addEventListener('click', ()=> $('fileInput').click());
    $('fileInput').addEventListener('change', (e)=>{
      const files=Array.from(e.target.files||[]);
      files.forEach(f=> state.anexos.push({file:f,title:baseName(f.name),kind:guessKind(f.name)}));
      e.target.value=''; renderAnexos();
    });
    $('btnClearFiles').addEventListener('click', ()=>{ state.anexos=[]; renderAnexos(); });

    function baseName(name){ const dot=name.lastIndexOf('.'); return dot>0? name.slice(0,dot):name; }
    function extOf(name){ return (name.split('.').pop()||'').toLowerCase(); }
    function guessKind(name){
      const n=name.toLowerCase();
      if(n.includes('dni')) return 'DNI';
      if(n.includes('contrato')) return 'Contrato';
      if(n.includes('poder')) return 'Poder';
      if(n.includes('demanda')) return 'Demanda';
      if(n.includes('factura')) return 'Factura';
      return 'Otros';
    }
    function fmtSize(bytes){ if(bytes<1024) return bytes+' B'; const kb=bytes/1024; if(kb<1024) return kb.toFixed(1)+' KB'; const mb=kb/1024; return mb.toFixed(2)+' MB'; }

    function renderAnexos(){
      const tbody=$('anexosBody'); tbody.innerHTML='';
      if(state.anexos.length===0){
        tbody.innerHTML='<tr><td colspan="6" class="muted" style="text-align:center;padding:12px">Sin anexos aún</td></tr>';
        $('filesStatus').textContent=''; return;
      }
      state.anexos.forEach((it,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${idx+1}</td>
          <td><input data-idx="${idx}" data-role="title" value="${escapeHtml(it.title)}"/></td>
          <td><select data-idx="${idx}" data-role="kind">${['DNI','Contrato','Constancia','Factura','Poder','Demanda','Otros'].map(k=>`<option ${k===it.kind?'selected':''}>${k}</option>`).join('')}</select></td>
          <td class="file-cell" title="${it.file.name}">${it.file.name}</td>
          <td class="right">${fmtSize(it.file.size)}</td>
          <td>
            <div class="actions">
              <button class="btn small ghost" type="button" data-idx="${idx}" data-act="up">↑</button>
              <button class="btn small ghost" type="button" data-idx="${idx}" data-act="down">↓</button>
              <button class="btn small" type="button" style="background:#ef4444;color:#fff" data-idx="${idx}" data-act="del">Eliminar</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('input[data-role="title"]').forEach(inp=>
        inp.addEventListener('input',e=>{ state.anexos[+e.target.dataset.idx].title=e.target.value; })
      );
      tbody.querySelectorAll('select[data-role="kind"]').forEach(sel=>
        sel.addEventListener('change',e=>{ state.anexos[+e.target.dataset.idx].kind=e.target.value; })
      );
      tbody.querySelectorAll('button[data-act]').forEach(btn=>
        btn.addEventListener('click',()=>{
          const i=+btn.dataset.idx, act=btn.dataset.act;
          if(act==='up'&&i>0){ const t=state.anexos[i-1]; state.anexos[i-1]=state.anexos[i]; state.anexos[i]=t; }
          if(act==='down'&&i<state.anexos.length-1){ const t=state.anexos[i+1]; state.anexos[i+1]=state.anexos[i]; state.anexos[i]=t; }
          if(act==='del'){ state.anexos.splice(i,1); }
          renderAnexos();
        })
      );
      const total=state.anexos.reduce((a,b)=>a+b.file.size,0);
      $('filesStatus').textContent=`${state.anexos.length} anexo(s) — ${fmtSize(total)} totales`;
    }

    /* ========== Firma digital ========== */
    const sigPop=$('sigPop'), btnSigOpen=$('btnSigOpen'), sigClose=$('sigClose');
    const sigCanvas=$('sigCanvas'), sigNombre=$('sigNombre'), sigMini=$('sigMini'), sigTxt=$('sigTxt');
    const sigClear=$('sigClear'), sigSave=$('sigSave');
    const sigCtx=sigCanvas.getContext('2d');

    const resizeSig=()=>{
      const dpr=window.devicePixelRatio||1;
      sigCanvas.width=sigCanvas.clientWidth*dpr;
      sigCanvas.height=sigCanvas.clientHeight*dpr;
      sigCtx.setTransform(dpr,0,0,dpr,0,0);
      sigCtx.fillStyle='#fff'; sigCtx.fillRect(0,0,sigCanvas.clientWidth,sigCanvas.clientHeight);
      sigCtx.strokeStyle='#0f3d73'; sigCtx.lineWidth=2;
    };
    window.addEventListener('resize', ()=>{ if(sigPop.classList.contains('show')) resizeSig(); });

    let drawing=false, last={x:0,y:0};
    function pos(e){ const r=sigCanvas.getBoundingClientRect(); const t=e.touches? e.touches[0]: e; return {x:t.clientX-r.left, y:t.clientY-r.top}; }
    function start(e){ drawing=true; last=pos(e); }
    function move(e){ if(!drawing) return; const p=pos(e); sigCtx.beginPath(); sigCtx.moveTo(last.x,last.y); sigCtx.lineTo(p.x,p.y); sigCtx.stroke(); last=p; }
    function end(){ drawing=false; }

    function openSig(){
      sigPop.classList.add('show');
      setTimeout(()=>{
        resizeSig();
        const stored = state.signatureDataUrl||localStorage.getItem('jab.signatureDataUrl');
        if(stored){
          const img=new Image();
          img.onload=()=>{ sigCtx.drawImage(img,10,10,sigCanvas.clientWidth-20,sigCanvas.clientHeight-20); };
          img.src=stored;
        }
      },0);
      sigNombre.value = state.signatureName||localStorage.getItem('jab.signatureName')||'';
    }
    function closeSig(){ sigPop.classList.remove('show'); }

    sigCanvas.addEventListener('mousedown', start); sigCanvas.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
    sigCanvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); start(e); });
    sigCanvas.addEventListener('touchmove', (e)=>{ e.preventDefault(); move(e); });
    sigCanvas.addEventListener('touchend', (e)=>{ e.preventDefault(); end(); });

    sigClear.addEventListener('click', ()=>{ sigCtx.clearRect(0,0,sigCanvas.clientWidth,sigCanvas.clientHeight); resizeSig(); });
    sigSave.addEventListener('click', ()=>{
      state.signatureDataUrl = sigCanvas.toDataURL('image/png');
      state.signatureName = sigNombre.value||'';
      localStorage.setItem('jab.signatureDataUrl', state.signatureDataUrl);
      localStorage.setItem('jab.signatureName', state.signatureName);
      updateSigChip();
      closeSig();
      toast('Firma guardada','ok');
    });
    btnSigOpen.addEventListener('click', openSig);
    sigClose.addEventListener('click', closeSig);

    function updateSigChip(){
      const dataUrl = state.signatureDataUrl || localStorage.getItem('jab.signatureDataUrl');
      const name = state.signatureName || localStorage.getItem('jab.signatureName') || '';
      if(dataUrl){ sigMini.style.backgroundImage = `url(${dataUrl})`; sigTxt.textContent = name? `Firma: ${name}`: 'Firma guardada'; }
      else { sigMini.style.backgroundImage='none'; sigTxt.textContent='Sin firma'; }
    }
    (function initSignature(){
      state.signatureDataUrl = localStorage.getItem('jab.signatureDataUrl');
      state.signatureName = localStorage.getItem('jab.signatureName')||'';
      updateSigChip();
    })();

    /* ========== Guardar / Cargar ========== */
    $('btnGuardar').addEventListener('click', async ()=>{
      try{
        const persona=collectPersona();
        if(!persona.id){ toast('Ingresá DNI/CUIT del cliente','err'); return; }

        const anexosPacked=await Promise.all(state.anexos.map(async a=>({
          name:a.file.name,type:a.file.type,size:a.file.size,title:a.title,kind:a.kind,bytes:await a.file.arrayBuffer()
        })));

        const exp=collectExpediente();
        exp.id=exp.id || `exp-${Date.now()}`;
        exp.personaId=persona.id;
        exp.updatedAt=Date.now();
        exp.anexos=anexosPacked;
        exp.sig=state.signatureDataUrl||localStorage.getItem('jab.signatureDataUrl')||null;
        exp.sigNombre=state.signatureName||localStorage.getItem('jab.signatureName')||'';

        await savePersona(persona);
        await saveExpediente(exp);

        state.currentExpId=exp.id; state.currentPersonaId=persona.id;
        $('status').textContent=`Guardado: ${exp.id}`;
        toast('✅ Expediente guardado','ok');
        clearAllForms(false);
        if($('expOverlay').classList.contains('show')) renderOverlayTable();
      }catch(err){
        console.error(err);
        toast('Error al guardar','err');
        $('status').textContent=err?.message||'Error';
      }
    });

    $('btnEliminar').addEventListener('click', async ()=>{
      if(!state.currentExpId){ toast('No hay expediente cargado','err'); return;}
      await deleteExpediente(state.currentExpId);
      toast('Expediente eliminado','ok');
      $('status').textContent='Expediente eliminado';
      clearAllForms(false);
      if($('expOverlay').classList.contains('show')) renderOverlayTable();
    });

    function collectPersona(){
      const id=($('cli_doc').value||'').trim();
      return { id, doc:id, nombre:$('cli_nombre').value.trim(),
        nombreLower:($('cli_nombre').value||'').trim().toLowerCase(),
        dom:$('cli_dom').value.trim(), contacto:$('cli_contacto').value.trim(), updatedAt:Date.now()
      };
    }
    function collectExpediente(){
      return { id:state.currentExpId, tipo:$('exp_tipo').value.trim(), juzgado:$('exp_juzgado').value.trim(),
        numero:$('exp_num').value.trim(), caratula:$('exp_caratula').value.trim(),
        fecha:$('exp_fecha').value || new Date().toISOString().slice(0,10), obs:$('exp_obs').value.trim()
      };
    }
    function fillPersona(p){ if(!p) return; $('cli_doc').value=p.doc||''; $('cli_nombre').value=p.nombre||''; $('cli_dom').value=p.dom||''; $('cli_contacto').value=p.contacto||''; }
    function fillExpediente(exp){ if(!exp) return; state.currentExpId=exp.id; $('exp_tipo').value=exp.tipo||''; $('exp_juzgado').value=exp.juzgado||''; $('exp_num').value=exp.numero||''; $('exp_caratula').value=exp.caratula||''; $('exp_fecha').value=exp.fecha||''; $('exp_obs').value=exp.obs||''; }
    function clearExpedienteForm(){ state.currentExpId=null; $('exp_tipo').value=''; $('exp_juzgado').value=''; $('exp_num').value=''; $('exp_caratula').value=''; $('exp_fecha').value=''; $('exp_obs').value=''; }
    function clearPersonaForm(){ $('cli_doc').value=''; $('cli_nombre').value=''; $('cli_dom').value=''; $('cli_contacto').value=''; }
    function clearAllForms(resetSignature){
      clearPersonaForm(); clearExpedienteForm(); state.anexos=[]; renderAnexos();
      if(resetSignature){
        localStorage.removeItem('jab.signatureDataUrl'); localStorage.removeItem('jab.signatureName');
        state.signatureDataUrl=null; state.signatureName=''; updateSigChip();
      }
      window.scrollTo({top:0,behavior:'smooth'});
    }
    $('btnNuevoExp').addEventListener('click', ()=>{ clearAllForms(false); $('status').textContent='Nuevo expediente listo'; toast('Formulario limpio','ok'); });

    function newFromPacked(ax){ const blob=new Blob([ax.bytes],{type:ax.type}); const f=new File([blob], ax.name,{type:ax.type}); return {file:f,title:ax.title,kind:ax.kind}; }

    /* ========== Overlay ========== */
    const overlay=$('expOverlay'), expTableBody=$('expTableBody');
    function openExpOverlay(){ overlay.classList.add('show'); renderOverlayTable(); }
    function closeExpOverlay(){ overlay.classList.remove('show'); }
    $('btnListExp').addEventListener('click', openExpOverlay);
    $('expBack').addEventListener('click', ()=>{ closeExpOverlay(); window.scrollTo({top:0,behavior:'smooth'}); });

    $('expSearchBtn').addEventListener('click', renderOverlayTable);
    $('expSearchBox').addEventListener('input', ()=>{ if($('expSearchBox').value.trim().length===0) renderOverlayTable(); });

    async function renderOverlayTable(){
      let items = await getAllExpedientes();
      const term = ($('expSearchBox').value||'').trim().toLowerCase();
      const personasCache = {};
      for(const e of items){
        if(!personasCache[e.personaId]) personasCache[e.personaId] = await getPersonaById(e.personaId);
      }
      const filterMatch = (e)=>{
        if(!term) return true;
        const p = personasCache[e.personaId]||{};
        const hay = [p.nombre||'', p.doc||'', e.numero||'', e.caratula||'', e.juzgado||'', e.tipo||''].join(' ').toLowerCase();
        return hay.includes(term);
      };
      items = items.filter(filterMatch);
      items.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0) );

      expTableBody.innerHTML='';
      if(items.length===0){
        expTableBody.innerHTML='<tr><td colspan="8" class="muted" style="text-align:center;padding:14px">No se encontraron expedientes.</td></tr>';
        $('expCount').textContent='0 resultados'; return;
      }
      for(const e of items){
        const p = personasCache[e.personaId]||{};
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(p.nombre||'(Sin nombre)')}</td>
          <td>${escapeHtml(p.doc||'-')}</td>
          <td>${escapeHtml(e.numero||e.id)}</td>
          <td>${escapeHtml(e.caratula||'-')}</td>
          <td>${escapeHtml(e.tipo||'-')}</td>
          <td>${escapeHtml(e.juzgado||'-')}</td>
          <td>${formatDateTime(e.updatedAt)}</td>
          <td><button class="btn small" type="button" data-open="${e.id}">Abrir</button></td>`;
        expTableBody.appendChild(tr);
      }
      $('expCount').textContent = `${items.length} expediente(s)`;
      expTableBody.querySelectorAll('button[data-open]').forEach(btn=> btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-open'); const exp = await getExpedienteById(id); if(!exp) return;
        const persona = await getPersonaById(exp.personaId);
        fillPersona(persona); fillExpediente(exp);
        state.anexos=(exp.anexos||[]).map(ax=>newFromPacked(ax)); renderAnexos();
        state.currentPersonaId=exp.personaId; state.currentExpId=exp.id;
        toast('Expediente cargado','ok');
        closeExpOverlay();
        window.scrollTo({top:0,behavior:'smooth'});
      }));
    }
    function formatDateTime(ts){
      try{ const d=new Date(ts); const pad=n=>String(n).padStart(2,'0');
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }catch{ return '-'; }
    }

    /* ========== Búsqueda topbar ========== */
    const resultsBox = $('searchResults');
    const showResults = (items)=>{
      resultsBox.innerHTML='';
      if(items.length===0){ resultsBox.classList.remove('show'); return; }
      items.forEach(p=>{
        const div=document.createElement('div'); div.className='result-item';
        div.innerHTML = `<div class="r-avatar">${(p.nombre||'').split(' ').map(s=>s[0]).join('').slice(0,2) || 'H'}</div>
                         <div><div style="font-weight:600">${p.nombre||'(Sin nombre)'}</div>
                         <div class="r-meta">DNI/CUIT: ${p.doc||'-'}</div></div>`;
        div.addEventListener('click', async ()=>{
          resultsBox.classList.remove('show'); fillPersona(p); state.currentPersonaId=p.id;
          const exps=await getExpedientesByPersona(p.id);
          if(exps.length){
            exps.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0) );
            const exp=exps[0]; fillExpediente(exp);
            state.anexos=(exp.anexos||[]).map(ax=>newFromPacked(ax)); renderAnexos();
            state.currentExpId=exp.id; toast('Persona cargada','ok');
            window.scrollTo({top:0,behavior:'smooth'});
          }
        });
        resultsBox.appendChild(div);
      });
      resultsBox.classList.add('show');
    };
    $('btnSearch').addEventListener('click', async ()=>{ const q=$('searchBox').value; showResults(await searchPersonas(q)); });
    $('searchBox').addEventListener('input', async ()=>{
      const q=$('searchBox').value; if(q.trim().length<2){ resultsBox.classList.remove('show'); return; }
      showResults(await searchPersonas(q));
    });
    document.addEventListener('click', (e)=>{ if(!resultsBox.contains(e.target) && e.target!==$('searchBox')) resultsBox.classList.remove('show'); });

    /* ========== Contacto solo números ========== */
    const contactInput = $('cli_contacto');
    contactInput.addEventListener('input', ()=>{
      const digits = contactInput.value.replace(/\D/g,'');
      contactInput.value = digits;
    });

    /* ========== WhatsApp (deep-link + fallback) ========== */
    $('btnWhatsApp').addEventListener('click', ()=>{
      const persona=collectPersona(); const exp=collectExpediente();
      const phone = getCleanPhone(($('cli_contacto').value||''));
      if(!phone){ toast('Ingresá un celular válido con código país (ej: 549261...)','err'); return; }
      const mensaje = composeWhatsApp(persona, exp);
      openWhatsApp(phone, mensaje);
    });
    function getCleanPhone(raw){
      const only = (raw||'').replace(/\D/g,'');
      return (only.length >= 10) ? only : null;
    }
    function composeWhatsApp(p, e){
      const estudio = 'Hugo Alonso Batistini';
      return `Estimado/a ${p.nombre||''},\n\nLe contactamos de *${estudio}*. Registramos su demanda${e.tipo? ' ('+e.tipo+')':''}.\n\n*Expediente:* ${e.numero||'-'}\n*Carátula:* ${e.caratula||'-'}\n*Juzgado:* ${e.juzgado||'-'}\n*Fecha:* ${e.fecha||new Date().toISOString().slice(0,10)}\n\nPróximos pasos: nos comunicaremos ante cualquier novedad o requerimiento.\n\nSaludos cordiales.`;
    }
    function openWhatsApp(phone, text){
      const waDeep = `whatsapp://send?phone=${phone}&text=${encodeURIComponent(text)}`;
      const waWeb  = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      if(isMobile){
        location.href = waDeep;
        setTimeout(()=>{ window.open(waWeb,'_blank') || (location.href = waWeb); }, 900);
      }else{
        const win = window.open(waWeb,'_blank');
        if(!win){ location.href = waWeb; }
      }
    }

    /* ========== DEMO ========== */
    $('btnDemo').addEventListener('click', async ()=>{
      const makeImg=async (label)=>{
        const cnv=document.createElement('canvas'); cnv.width=1000; cnv.height=1414; const cx=cnv.getContext('2d');
        cx.fillStyle='#ffffff'; cx.fillRect(0,0,cnv.width,cnv.height);
        cx.fillStyle='#0f3d73'; cx.fillRect(0,0,cnv.width,80);
        cx.fillStyle='#b88a28'; cx.fillRect(0,1320,cnv.width,14);
        cx.fillStyle='#111827'; cx.font='bold 48px Arial'; cx.fillText(label, 40, 140);
        cx.font='24px Arial'; cx.fillText('Documento de muestra — Estudio HAB', 40, 200);
        const blob=await new Promise(r=>cnv.toBlob(r,'image/png'));
        return new File([await blob.arrayBuffer()], `${label}.png`, {type:'image/png'});
      };
      await ensurePdfLib();
      const { PDFDocument }=PDFLib;
      const img1=await makeImg('DNI Frente'); const img2=await makeImg('DNI Dorso');
      const d=await PDFDocument.create(); d.addPage([595.28,841.89]); const bytes=await d.save();
      const pdfFile=new File([bytes],'Escrito_Demanda.pdf',{type:'application/pdf'});
      $('cli_nombre').value='Juan Pérez'; $('cli_doc').value='30123456'; $('cli_dom').value='Sarmiento 123, Maipú, Mendoza';
      $('cli_contacto').value='5492615555555';
      $('exp_tipo').value='Laboral'; $('exp_juzgado').value='Juzgado Laboral 5º';
      $('exp_num').value='12345/2025'; $('exp_caratula').value='Pérez, Juan c/ Empresa SA s/ Despido';
      $('exp_fecha').value=(new Date()).toISOString().slice(0,10);
      $('exp_obs').value='Solicita indemnización por despido sin causa. Se adjunta documentación respaldatoria.';
      state.anexos=[{file:img1,title:'DNI Frente',kind:'DNI'},{file:img2,title:'DNI Dorso',kind:'DNI'},{file:pdfFile,title:'Escrito de Demanda',kind:'Demanda'}];
      renderAnexos(); toast('Demo cargada','ok'); window.scrollTo({top:0,behavior:'smooth'});
    });

    /* ========== Generar PDF (robusto) ========== */
    $('btnGenerar').addEventListener('click', async ()=>{
      try{
        if(state.anexos.length===0){ toast('Agregá al menos un anexo','err'); return; }
        await ensurePdfLib();
        const { PDFDocument, StandardFonts, rgb } = PDFLib;

        $('status').textContent='Generando PDF…';
        const pre=[], errores=[];
        for(const it of state.anexos){
          const ex=extOf(it.file.name);
          if(ex==='pdf'){
            try{
              const bytes=await it.file.arrayBuffer();
              const src=await PDFDocument.load(bytes);
              pre.push({type:'pdf',title:it.title,kind:it.kind,src,pageCount:src.getPageCount()});
            }catch(e){
              console.error('PDF inválido:', it.file.name, e);
              errores.push(it.file.name);
            }
          } else if(['png','jpg','jpeg'].includes(ex)){
            pre.push({type:'img',title:it.title,kind:it.kind,file:it.file,pageCount:1});
          }
        }
        if(pre.length===0){ toast('No se pudo procesar ningún anexo','err'); return; }
        if(errores.length){ toast('Algunos PDFs no se pudieron leer (ver consola)', 'err'); }

        const A4=[595.28,841.89], margin=50, lineH=14;
        const master=await PDFDocument.create();
        const font=await master.embedFont(StandardFonts.TimesRoman);
        const fontBold=await master.embedFont(StandardFonts.TimesRomanBold);
        const colPrimary=rgb(0x0f/255,0x3d/255,0x73/255), colGold=rgb(0xb8/255,0x8a/255,0x28/255), colText=rgb(0x23/255,0x27/255,0x2a/255), colMuted=rgb(0x66/255,0x74/255,0x86/255);

        // Carátula
        const cover=master.addPage(A4);
        cover.drawText('Hugo Alonso Batistini',{x:margin,y:A4[1]-margin-24,size:20,font:fontBold,color:colPrimary});
        cover.drawText('Estudio Jurídico',{x:margin,y:A4[1]-margin-44,size:12,font:font,color:colGold});
        cover.drawLine({start:{x:margin,y:A4[1]-margin-74},end:{x:A4[0]-margin,y:A4[1]-margin-74},thickness:1,color:colPrimary});

        let y=A4[1]-margin-100;
        const f=(label,val)=>{ cover.drawText(label,{x:margin,y,size:12,font:fontBold,color:colMuted}); cover.drawText(val||'-',{x:margin+160,y,size:12,font:font,color:colText}); y-=18; };
        cover.drawText('CARÁTULA DE EXPEDIENTE',{x:margin,y:y,size:16,font:fontBold,color:colPrimary}); y-=24;
        f('Cliente:', $('cli_nombre').value.trim());
        f('DNI/CUIT:', $('cli_doc').value.trim());
        f('Domicilio:', $('cli_dom').value.trim());
        f('Contacto:', $('cli_contacto').value.trim()); y-=8;
        f('Tipo de Demanda:', $('exp_tipo').value.trim());
        f('Juzgado:', $('exp_juzgado').value.trim());
        f('N° de Expediente:', $('exp_num').value.trim());
        f('Carátula:', $('exp_caratula').value.trim());
        f('Fecha:', $('exp_fecha').value || new Date().toISOString().slice(0,10));
        y-=8;
        cover.drawText('Observaciones:',{x:margin,y,size:12,font:fontBold,color:colMuted}); y-=16;
        y = drawWrapped(cover, ($('exp_obs').value||'—').trim(), {x:margin,y,w:A4[0]-margin*2,lineH:14,font,size:12,color:colText});

        // Firma (opcional)
        const sigData = state.signatureDataUrl||localStorage.getItem('jab.signatureDataUrl');
        const sigName = state.signatureName||localStorage.getItem('jab.signatureName')||'';
        if(sigData){
          const sigBytes=dataURLtoUint8(sigData);
          const sigImg=await master.embedPng(sigBytes);
          const sigW=160, sigH=60;
          cover.drawText('Firmado digitalmente por:',{x:A4[0]-margin- sigW -10, y:150, size:10, font:font, color:colMuted});
          cover.drawImage(sigImg,{x:A4[0]-margin- sigW, y:80, width:sigW, height:sigH});
          cover.drawText(sigName||'HAB — Estudio Jurídico',{x:A4[0]-margin- sigW, y:70, size:10, font:font, color:colText});
        }

        // Índice
        const linesPerPage=Math.floor((A4[1]-margin*2-40)/lineH);
        const indexPagesNeeded=Math.max(1, Math.ceil(pre.length/linesPerPage));
        const startPageAnnex=1+indexPagesNeeded;
        let running=startPageAnnex; const startPages=[];
        pre.forEach(it=>{ startPages.push(running); running+=it.pageCount; });

        let idx=0;
        for(let p=0;p<indexPagesNeeded;p++){
          const page=master.addPage(A4);
          page.drawText('ÍNDICE DE ANEXOS',{x:margin,y:A4[1]-margin-24,size:16,font:fontBold,color:colPrimary});
          let iy=A4[1]-margin-50;
          for(let l=0;l<linesPerPage && idx<pre.length;l++){
            const item=pre[idx]; const title=`${idx+1}. ${item.title} — ${item.kind}`; const pn=startPages[idx];
            page.drawText(title,{x:margin,y:iy,size:12,font:font,color:colText});
            const m=font.widthOfTextAtSize(String(pn),12);
            page.drawText(String(pn),{x:A4[0]-margin-m,y:iy,size:12,font:fontBold,color:colPrimary});
            iy-=lineH; idx++;
          }
        }

        // Anexos
        for(const item of pre){
          if(item.type==='pdf'){
            const pages=await master.copyPages(item.src, item.src.getPageIndices());
            pages.forEach(p=> master.addPage(p));
          } else {
            const bytes=await item.file.arrayBuffer();
            const page=master.addPage(A4);
            const img=(extOf(item.file.name)==='png')? await master.embedPng(bytes): await master.embedJpg(bytes);
            const maxW=A4[0]-margin*2, maxH=A4[1]-margin*2-20;
            const s=Math.min(maxW/img.width, maxH/img.height);
            const w=img.width*s, h=img.height*s;
            page.drawText(`Anexo: ${item.title} — ${item.kind}`,{x:margin,y:A4[1]-margin-16,size:11,font:font,color:colMuted});
            page.drawImage(img,{x:(A4[0]-w)/2,y:(A4[1]-h)/2-10,width:w,height:h});
          }
        }

        // Footer
        const pages=master.getPages(); const total=pages.length; const today=new Date().toISOString().slice(0,10);
        pages.forEach((p,i)=>{
          p.drawLine({start:{x:margin,y:30},end:{x:A4[0]-margin,y:30},thickness:.5,color:colPrimary});
          const left='Hugo Alonso Batistini — Confidencial';
          const right=`Página ${i+1} de ${total}`;
          p.drawText(left,{x:margin,y:16,size:10,font:font,color:colMuted});
          const wR=font.widthOfTextAtSize(right,10); p.drawText(right,{x:A4[0]-margin-wR,y:16,size:10,font:font,color:colMuted});
          const wD=font.widthOfTextAtSize(today,10); p.drawText(today,{x:(A4[0]-wD)/2,y:16,size:10,font:font,color:colMuted});
        });

        // Descargar
        const pdfBytes=await master.save();
        const blob=new Blob([pdfBytes],{type:'application/pdf'});
        const safeDoc=($('cli_doc').value||'cliente').replace(/\s+/g,'_').replace(/[^\w.-]/g,'');
        const safeNum=($('exp_num').value||'expediente').replace(/\s+/g,'_').replace(/[^\w.-]/g,'');
        const filename=`HAB_expediente_${safeDoc}_${safeNum}.pdf`;
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download=filename;
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>{ URL.revokeObjectURL(url); }, 60000);

        $('status').textContent='PDF generado con éxito';
        toast('PDF generado','ok');
      }catch(err){
        console.error(err);
        $('status').textContent='Error generando el PDF';
        toast('Error al generar PDF','err');
      }
    });

    /* ========== Aux PDF ========== */
    function drawWrapped(page, text, {x,y,w,lineH,font,size,color}){
      if(!text) return y; const words=text.split(/\s+/); let line=''; let cy=y;
      const draw=(s)=>page.drawText(s,{x,y:cy,size,font,color});
      words.forEach((wrd)=>{
        const test=line? line+' '+wrd : wrd; const width=font.widthOfTextAtSize(test,size);
        if(width>w && line){ draw(line); cy-=lineH; line=wrd; } else { line=test; }
      });
      if(line){ draw(line); cy-=lineH; }
      return cy;
    }

    /* ========== Dictado por voz (secuencial + símbolos) ========== */
    const voiceBtn = $('voiceFab');
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const fieldOrder = ['cli_nombre','cli_doc','cli_dom','cli_contacto','exp_tipo','exp_juzgado','exp_num','exp_caratula','exp_fecha','exp_obs'];
    let rec=null, listening=false;

    function isEditable(el){ return el && (el.tagName==='INPUT' || el.tagName==='TEXTAREA'); }
    function firstEmptyField(){
      for(const id of fieldOrder){ const el=$(id); if(el && !el.value) return el; }
      return $(fieldOrder[0]);
    }
    function nextField(fromId){
      let i = fieldOrder.indexOf(fromId); for(let j=i+1;j<fieldOrder.length;j++){ const el=$(fieldOrder[j]); if(el) return el; }
      return null;
    }
    function focusAndCenter(el){
      if(!el) return;
      el.focus(); el.scrollIntoView({behavior:'smooth', block:'center'});
    }
    function monthEsToNum(m){
      const M = {'enero':1,'febrero':2,'marzo':3,'abril':4,'mayo':5,'junio':6,'julio':7,'agosto':8,'septiembre':9,'setiembre':9,'octubre':10,'noviembre':11,'diciembre':12};
      return M[(m||'').toLowerCase()]||null;
    }
    function parseDateEs(t){
      t = t.trim().toLowerCase();
      // 12/3/2025 o 12-03-2025
      let m = t.match(/\b(\d{1,2})[\/\- ](\d{1,2})[\/\- ](\d{2,4})\b/);
      if(m){ const d=m[1].padStart(2,'0'), mo=m[2].padStart(2,'0'), y=(m[3].length===2?('20'+m[3]):m[3]); return `${y}-${mo}-${d}`; }
      // 12 de marzo de 2025
      m = t.match(/\b(\d{1,2})\s*(de)?\s*([a-záéíóú]+)\s*(de)?\s*(\d{2,4})\b/);
      if(m){ const d=m[1].padStart(2,'0'), mo=String(monthEsToNum(m[3])||1).padStart(2,'0'), y=(m[5].length===2?('20'+m[5]):m[5]); return `${y}-${mo}-${d}`; }
      // yyyy-mm-dd directo
      m = t.match(/\b(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})\b/);
      if(m){ const y=m[1], mo=m[2].padStart(2,'0'), d=m[3].padStart(2,'0'); return `${y}-${mo}-${d}`; }
      return '';
    }

    // Mapeo voz -> símbolos (incluye "barra" -> "/", "punto" -> ".")
    function toSymbols(text){
      const orig = text.trim().split(/\s+/);
      const norm = orig.map(t=> t.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''));
      const pairs = [
        ['punto y coma',';'],
        ['dos puntos',':'],
        ['guion bajo','_'],
        ['barra invertida','\\'],
        ['abre parentesis','('],
        ['cierra parentesis',')'],
        ['arroba','@'],
        ['coma',','],
        ['punto','.'],
        ['guion','-'], ['guión','-'],
        ['slash','/'], ['barra','/'],
        ['espacio',' ']
      ];
      let out=[], i=0;
      while(i<norm.length){
        const two = (norm[i]||'')+' '+(norm[i+1]||'');
        const m2 = pairs.find(([k])=>k===two);
        if(m2){ out.push(m2[1]); i+=2; continue; }
        const one = norm[i];
        const m1 = pairs.find(([k])=>k===one);
        if(m1){ out.push(m1[1]); i+=1; continue; }
        out.push(orig[i]); i+=1;
      }
      // Ajuste de espacios antes de signos comunes
      let s = out.join(' ');
      s = s.replace(/\s+([.,;:\/\\\)\]])/g,'$1').replace(/([\(\[])\s+/g,'$1');
      return s;
    }

    if(!SpeechRecognition){
      voiceBtn.hidden = true;
    }else{
      function startRec(){
        if(!rec){
          rec = new SpeechRecognition();
          rec.lang = 'es-AR';
          rec.interimResults = false;
          rec.maxAlternatives = 1;
          rec.continuous = true;
          rec.addEventListener('result', onSpeechResult);
          rec.addEventListener('start', ()=>{ listening=true; voiceBtn.classList.add('listening'); voiceBtn.textContent='■ Detener'; toast('🎤 Dictado activo. Decí “siguiente” para avanzar.'); });
          rec.addEventListener('end',   ()=>{ listening=false; voiceBtn.classList.remove('listening'); voiceBtn.textContent='🎤 Dictar'; });
          rec.addEventListener('error', (e)=>{ listening=false; voiceBtn.classList.remove('listening'); voiceBtn.textContent='🎤 Dictar'; toast('No se pudo dictar ('+(e.error||'error')+')','err'); });
        }
        // Foco inicial
        let el = document.activeElement;
        if(!isEditable(el)){ el = firstEmptyField(); }
        focusAndCenter(el);
        rec.start();
      }
      function stopRec(){ try{ rec && rec.stop(); }catch{} }

      voiceBtn.addEventListener('click', ()=>{ listening ? stopRec() : startRec(); });

      function onSpeechResult(ev){
        const text = Array.from(ev.results).slice(ev.resultIndex).map(r=>r[0]?.transcript||'').join(' ').trim();
        if(!text) return;

        let el = document.activeElement;
        if(!isEditable(el)){ el = firstEmptyField(); focusAndCenter(el); }

        const tNorm = text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

        // Comandos de control
        if(/^(siguiente|next)$/.test(tNorm)){ const nx = nextField(el.id); if(nx){ focusAndCenter(nx); toast('➡️ Siguiente campo'); } else { stopRec(); toast('✅ Dictado finalizado'); } return; }
        if(/^(borrar|limpiar)$/.test(tNorm)){ el.value=''; el.dispatchEvent(new Event('input',{bubbles:true})); toast('🧹 Campo limpiado'); return; }
        if(/^(cancelar|terminar|stop)$/.test(tNorm)){ stopRec(); toast('✋ Dictado detenido'); return; }

        // Transformaciones de símbolos
        let val = toSymbols(text);

        // Entrada según campo
        if(el.id==='cli_doc' || el.id==='cli_contacto'){
          val = val.replace(/\D/g,'');
        }else if(el.id==='exp_fecha'){
          const parsed = parseDateEs(val);
          if(parsed) val = parsed;
        }

        // Escribe (concatena si ya había algo)
        el.value = el.value ? (el.value + (el.id==='cli_doc'||el.id==='cli_contacto' ? '' : ' ') + val) : val;
        el.dispatchEvent(new Event('input',{bubbles:true}));

        // Avanza automático al siguiente campo
        const nx = nextField(el.id);
        if(nx){ focusAndCenter(nx); }
        else { stopRec(); toast('✅ Dictado finalizado'); }
      }
    }

    /* ========== Accesos rápidos ========== */
    document.addEventListener('keydown',(e)=>{
      if(e.key==='Escape'){
        if($('expOverlay').classList.contains('show')) closeExpOverlay();
        if($('sigPop').classList.contains('show')) $('sigPop').classList.remove('show');
      }
    });

    // Querystring inicial (opcional)
    const params=new URLSearchParams(location.search); const q=params.get('q');
    if(q){ $('searchBox').value=q; (async()=>{ const rs=await searchPersonas(q); const box=$('searchResults'); if(rs.length) box.classList.add('show'); })(); }

    // Helpers necesarios
    function dataURLtoUint8(u){ const b64=u.split(',')[1]; const bin=atob(b64); const bytes=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i); return bytes; }
  </script>
</body>
</html>
