<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>Hugo Alonso Batistini ‚Äî Gesti√≥n Jur√≠dica & PDF √önico</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  /* ========= PALETA CLARA & BASE ========= */
  :root{
    /* Superficie */
    --bg-1:#f7fafc;     /* fondo superior */
    --bg-2:#ffffff;     /* fondo inferior */
    --card:#ffffff;     /* tarjetas */
    --elev:#ffffff;     /* barras, toolbars */
    --border:#e5e7eb;   /* bordes */

    /* Texto */
    --text:#1f2937;     /* principal */
    --muted:#6b7280;    /* secundario */
    --placeholder:#9ca3af;

    /* Marca */
    --primary:#1e3a8a;  /* √≠ndigo */
    --primary-2:#3b82f6;/* azul */
    --accent:#f59e0b;   /* dorado */
    --accent-2:#0ea5e9; /* cian info */
    --focus:rgba(59,130,246,.28);

    /* Estados */
    --ok:#10b981; --warn:#f59e0b; --err:#ef4444;

    /* Sombras */
    --shadow:0 10px 30px rgba(2,6,23,.06);
    --shadow-2:0 18px 48px rgba(2,6,23,.12);

    --radius:16px;
  }

  *{box-sizing:border-box}
  html,body{height:100%;max-width:100%;overflow-x:hidden}
  body{
    margin:0;
    background:
      radial-gradient(1100px 800px at -15% -10%, #eaf2ff 0%, transparent 40%),
      radial-gradient(1100px 800px at 110% -10%, #e8f7ff 0%, transparent 42%),
      linear-gradient(180deg,var(--bg-1),var(--bg-2) 60%);
    color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
    -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent;
  }
  img,canvas{max-width:100%}
  ::selection{background:rgba(59,130,246,.18)}
  input::placeholder, textarea::placeholder{ color:var(--placeholder); font-size:12px; opacity:.95 }

  /* ========= TOPBAR ========= */
  .topbar{
    position:sticky;top:0;z-index:70;
    background:rgba(255,255,255,.85);
    backdrop-filter:saturate(160%) blur(10px);
    border-bottom:1px solid var(--border);
  }
  .topbar .wrap{display:flex;flex-wrap:wrap;align-items:center;gap:12px;padding:10px 16px;max-width:1200px;margin:0 auto}
  .logo{
    width:42px;height:42px;border-radius:999px;
    border:2px solid var(--primary);display:grid;place-items:center;
    font-weight:900;color:#ffffff;background:linear-gradient(135deg,var(--primary),var(--primary-2));
    box-shadow:0 0 0 4px rgba(59,130,246,.15), var(--shadow); overflow:hidden;
  }
  .brand{font-weight:800;letter-spacing:.2px}
  .brand small{display:block;color:var(--muted);font-weight:600;font-size:12px;margin-top:-2px}

  /* ========= CHIP DE FIRMA ========= */
  .sig-chip{margin-left:auto;display:flex;align-items:center;gap:10px}
  .chip{
    display:flex;align-items:center;gap:8px;border:1px solid var(--border);
    background:linear-gradient(180deg,#ffffff,#f8fafc);
    border-radius:999px;padding:6px 10px;box-shadow:var(--shadow)
  }
  .chip .mini{width:64px;height:26px;border:1px solid var(--border);border-radius:8px;background:#f3f4f6;background-size:contain;background-position:center;background-repeat:no-repeat}
  .chip .txt{font-size:12px;color:var(--muted)}
  .chip .btn{padding:6px 10px}

  /* ========= BUSCADOR ========= */
  .searchbar{order:5;flex:1 0 100%;display:flex;gap:8px;align-items:center;position:relative}
  .searchbar input{
    flex:1;min-width:260px;padding:10px 12px;border:1px solid var(--border);
    border-radius:12px;background:#ffffff;color:var(--text);
    transition:border-color .2s ease, box-shadow .2s ease
  }
  .searchbar input:focus{outline:none;border-color:var(--primary-2); box-shadow:0 0 0 4px var(--focus)}
  .searchbar .results{
    position:absolute;top:44px;left:0;right:0;background:#ffffff;border:1px solid var(--border);
    border-radius:12px;box-shadow:var(--shadow-2);max-height:320px;overflow:auto;display:none
  }
  .searchbar .results.show{display:block}
  .result-item{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;gap:10px;cursor:pointer}
  .result-item:hover{background:#f3f4f6}
  .r-avatar{width:36px;height:36px;border-radius:999px;background:linear-gradient(135deg,#93c5fd,#3b82f6);color:#fff;display:grid;place-items:center;font-weight:800}
  .r-meta{font-size:12px;color:var(--muted)}

  /* ========= POPOVER FIRMA ========= */
  .sig-pop{
    position:fixed;right:16px;top:66px;width:min(540px,92vw);z-index:80;
    background:linear-gradient(180deg,#ffffff,#f8fafc);
    border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow-2);display:none
  }
  .sig-pop.show{display:block}
  .sig-pop .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 12px;border-bottom:1px solid var(--border)}
  .sig-pop .bd{padding:12px}
  .sig-pop .sig-canvas{width:100%;height:170px;border-radius:12px;border:1px solid var(--border);touch-action:none;cursor:crosshair;background:#ffffff}
  .sig-tools{display:flex;gap:8px;margin-top:8px}

  /* ========= LAYOUT & CARDS ========= */
  .wrap{max-width:1200px;margin:22px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{
    background:linear-gradient(180deg,#ffffff,#f9fafb);
    border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);
    transition:box-shadow .2s ease, transform .15s ease;
  }
  .card:hover{box-shadow:var(--shadow-2)}
  .card h2{margin:0 0 12px;font-size:18px;font-weight:800;color:#0f172a}
  label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px;font-weight:700;letter-spacing:.2px;text-transform:uppercase}
  input,select,textarea{
    width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;
    background:#ffffff;color:var(--text);font-size:15px;
    transition:box-shadow .2s ease, border-color .2s ease
  }
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary-2); box-shadow:0 0 0 4px var(--focus)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .help{font-size:12px;color:var(--muted)}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

  /* ========= BOTONES ========= */
  .btn{
    border:1px solid var(--border);
    background:linear-gradient(180deg,#ffffff,#f3f4f6);
    color:var(--text);
    padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:800;
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    min-height:44px;line-height:1.2;user-select:none;-webkit-user-select:none;
    touch-action:manipulation;-webkit-appearance:none;appearance:none;
    position:relative;box-shadow:var(--shadow);
    transition:transform .08s ease, box-shadow .2s ease, filter .2s ease, border-color .2s ease
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:var(--shadow-2) }
  .btn:active{ transform:translateY(0); filter:brightness(.98) }
  .btn.primary{
    background:linear-gradient(135deg,#93c5fd,#3b82f6);
    border-color:transparent; color:#0b1220;
    text-shadow:0 1px 0 rgba(255,255,255,.25)
  }
  .btn.accent{
    background:linear-gradient(135deg,#fde68a,var(--accent));
    border-color:transparent; color:#0b1220; text-shadow:0 1px 0 rgba(255,255,255,.25)
  }
  .btn.info{
    background:linear-gradient(135deg,#bae6fd,#0ea5e9);
    border-color:transparent; color:#0b1220; text-shadow:0 1px 0 rgba(255,255,255,.25)
  }
  .btn.ghost{background:transparent}
  .btn.small{padding:8px 12px;font-size:12px;min-height:36px}
  .status{font-size:13px;color:var(--muted);margin-top:6px}

  /* ========= TABLA ANEXOS (SIMPLE: nombre, tama√±o, eliminar) ========= */
  .table-holder{overflow:auto;border:1px solid var(--border);border-radius:14px;margin-top:10px;max-height:42vh;background:#ffffff}
  table{width:100%;border-collapse:collapse;table-layout:auto}
  th,td{border-bottom:1px solid var(--border);padding:10px 12px;font-size:14px;vertical-align:middle}
  th{
    background:linear-gradient(180deg,#ffffff,#f3f4f6);
    text-align:left;color:#0f172a; position:sticky; top:0; z-index:1
  }
  tbody tr:hover{background:#f9fafb}
  .file-cell{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
  .right{text-align:right}
  .muted{color:var(--muted)}

  /* ========= TOOLBAR ========= */
  .toolbar{margin-top:16px}
  .toolbar .bar{
    display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
    background:linear-gradient(180deg,#ffffff,#f8fafc);
    border:1px solid var(--border);padding:12px;border-radius:18px;box-shadow:var(--shadow)
  }

  /* ========= TOAST ========= */
  .toast{
    position:fixed;left:50%;bottom:22px;transform:translateX(-50%);
    min-width:280px;background:linear-gradient(135deg,#34d399,#60a5fa);
    color:#0b1220;padding:12px 16px;border-radius:14px;box-shadow:var(--shadow-2);
    font-weight:900;letter-spacing:.2px;opacity:0;transition:.25s;z-index:1000;display:flex;align-items:center;gap:10px
  }
  .toast.show{opacity:1}
  .toast .ico{width:18px;height:18px;display:inline-block}
  .toast.ok{background:linear-gradient(135deg,#34d399,#60a5fa)}
  .toast.err{background:linear-gradient(135deg,#fda4af,#fb7185)}

  /* ========= OVERLAY EXPEDIENTES ========= */
  .overlay{position:fixed;inset:0;background:#ffffff;z-index:999;display:none}
  .overlay.show{display:block}
  .ov-header{display:flex;align-items:center;gap:12px;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:linear-gradient(180deg,#ffffff,#f8fafc)}
  .ov-header h3{margin:0;font-size:18px}
  .ov-body{height:calc(100vh - 62px);display:flex;flex-direction:column;padding:12px 16px;gap:12px}
  .ov-search{display:flex;gap:8px;flex-wrap:wrap}
  .ov-table{flex:1;overflow:auto;border:1px solid var(--border);border-radius:14px;background:#ffffff}
  .ov-table th, .ov-table td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:14px}
  .ov-table tr:hover{background:#f9fafb}

  /* ========= BOT√ìN VOZ ========= */
  .voice-fab{
    position:fixed; right:16px; bottom:16px; z-index:1001;
    background:linear-gradient(135deg,#93c5fd,#3b82f6);
    border:1px solid #93c5fd; box-shadow:0 12px 38px rgba(59,130,246,.25);
    padding:12px 16px; border-radius:999px; font-weight:900; cursor:pointer; color:#0b1220;
    transition:transform .1s ease, box-shadow .2s ease, background .2s ease;
  }
  .voice-fab:hover{ transform:translateY(-1px) }
  .voice-fab.listening{ background:linear-gradient(135deg,#fde68a,#f59e0b); border-color:#facc15; box-shadow:0 14px 36px rgba(245,158,11,.25) }
  .voice-fab[hidden]{ display:none !important }

  /* ========= M√ìVIL ========= */
  @media (max-width:640px){
    .topbar .wrap{padding:8px 12px;gap:8px}
    .logo{width:36px;height:36px}
    .brand small{display:none}
    .wrap{padding:0 12px}
    .row,.row3{grid-template-columns:1fr}
    .btn{min-height:48px}
    .toolbar .bar{
      position:sticky; bottom:0; z-index:65;
      border-radius:18px; padding-bottom:calc(12px + env(safe-area-inset-bottom));
      box-shadow:0 -8px 24px rgba(2,6,23,.08);
    }
    .toolbar .bar .btn{flex:1 1 calc(50% - 8px)}
    .searchbar input{font-size:16px}
    .table-holder{max-height:52vh}
    .voice-fab{ bottom:calc(86px + env(safe-area-inset-bottom)) }
  }
  /* === Variantes de botones (paleta clara) === */
.btn.success{
  background:linear-gradient(135deg,#ecfdf5,#a7f3d0);
  border-color:#a7f3d0;
  color:#065f46;                  /* verde oscuro legible */
  text-shadow:0 1px 0 rgba(255,255,255,.35);
}
.btn.success:hover{ box-shadow:var(--shadow-2); border-color:#34d399; transform:translateY(-1px) }
.btn.success:active{ filter:brightness(.98) }

.btn.secondary{
  background:linear-gradient(180deg,#ffffff,#f3f7ff);
  border-color:#dbeafe;           /* azul 200 */
  color:var(--primary);           /* √≠ndigo de marca */
}
.btn.secondary:hover{ box-shadow:var(--shadow-2); border-color:#93c5fd; transform:translateY(-1px) }
.btn.secondary:active{ filter:brightness(.98) }

/* (opcional) √≠conos dentro del bot√≥n */
.btn .ico{font-size:14px; line-height:1; margin-right:6px}

</style>
</head>
<body>
  <header class="topbar">
    <div class="wrap">
      <div class="logo" id="uiLogo">HAB</div>
      <div class="brand">Hugo Alonso Batisttini <small>Gesti√≥n de expedientes ‚Äî PDF √∫nico & Base local</small></div>

      <div class="sig-chip">
        <div id="sigChip" class="chip">
          <div class="mini" id="sigMini" title="Vista previa de firma"></div>
          <div class="txt" id="sigTxt">Sin firma</div>
          <button id="btnSigOpen" class="btn small" type="button">Cargar/Editar</button>
        </div>
      </div>

      <div class="searchbar">
        <input id="searchBox" placeholder="Buscar persona por nombre o DNI‚Ä¶" autocomplete="off">
        <button id="btnSearch" class="btn small info" type="button">Buscar</button>
        <div id="searchResults" class="results"></div>
      </div>
    </div>
  </header>

  <!-- POPOVER FIRMA -->
  <div id="sigPop" class="sig-pop" role="dialog" aria-modal="true">
    <div class="hd">
      <strong>Firma digital del estudio</strong>
      <button id="sigClose" class="btn small" type="button">Cerrar</button>
    </div>
    <div class="bd">
      <canvas id="sigCanvas" class="sig-canvas"></canvas>
      <div class="sig-tools">
        <button id="sigClear" class="btn ghost" type="button">Limpiar</button>
        <input id="sigNombre" placeholder="Firmante (ej.: Dra. G√≥mez ‚Äî Mat. 1234)" style="flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#ffffff;color:#1f2937">
        <button id="sigSave" class="btn primary" type="button">Guardar firma</button>
      </div>
      <div class="help">Al guardar se ocultar√° este panel. La firma se insertar√° en la car√°tula del PDF.</div>
    </div>
  </div>

  <main class="wrap">
    <div class="grid">
      <section class="card">
        <h2>1) Datos del Cliente</h2>
        <div class="row">
          <div>
            <label>Nombre y Apellido</label>
            <input id="cli_nombre" placeholder="Ej: Juan P√©rez" required>
          </div>
          <div>
            <label>Contacto (solo celular con c√≥digo pa√≠s)</label>
            <input id="cli_contacto" placeholder="Ej: 5492615555555" inputmode="numeric" pattern="\d*" maxlength="16">
          </div>
        </div>
        <div class="row">
          <div>
            <label>DNI / CUIT (√∫nico)</label>
            <input id="cli_doc" placeholder="Ej: 30123456" required>
          </div>
          <div>
            <label>Domicilio</label>
            <input id="cli_dom" placeholder="Calle 123, Maip√∫, Mendoza">
          </div>
        </div>

        <h2 style="margin-top:18px">2) Datos del Expediente</h2>
        <div class="row3">
          <div>
            <label>Tipo de Demanda</label>
            <input id="exp_tipo" placeholder="Laboral / Civil / Comercial...">
          </div>
          <div>
            <label>Juzgado</label>
            <input id="exp_juzgado" placeholder="Juzgado 5¬∫ de...">
          </div>
          <div>
            <label>N¬∞ de Expediente</label>
            <input id="exp_num" placeholder="Expte. 12345/2025">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Car√°tula</label>
            <input id="exp_caratula" placeholder="P√©rez, Juan c/ Empresa SA s/ Despido">
          </div>
          <div>
            <label>Fecha</label>
            <input id="exp_fecha" type="date">
          </div>
        </div>
        <label>Observaciones</label>
        <textarea id="exp_obs" rows="3" placeholder="Notas internas, medidas cautelares, plazos, etc."></textarea>
<div class="actions">
  <button id="btnNuevoExp" class="btn success" type="button">
    <span class="ico">‚ûï</span>Nuevo expediente
  </button>
  <button id="btnListExp" class="btn secondary" type="button">
    <span class="ico">üóÇÔ∏è</span>Ver expedientes guardados
  </button>
</div>

        <div id="expList" class="status"></div>
      </section>

      <section class="card">
        <h2>3) Anexos del Expediente</h2>
        <div class="actions">
          <input id="fileInput" type="file" accept=".pdf,.png,.jpg,.jpeg" multiple hidden>
          <button id="btnAddFiles" class="btn" type="button">Agregar archivos</button>
          <button id="btnClearFiles" class="btn ghost" type="button">Limpiar anexos</button>
        </div>
        <p class="help">Carg√° <b>varios documentos</b> (PDF, JPG, PNG). Se unir√°n en un PDF con car√°tula e √≠ndice.</p>

        <div class="table-holder">
          <table>
            <thead>
              <tr>
                <th>Nombre</th>
                <th class="right" style="width:140px">Tama√±o</th>
                <th style="width:140px">Acciones</th>
              </tr>
            </thead>
            <tbody id="anexosBody">
              <tr><td colspan="3" class="muted" style="text-align:center;padding:12px">Sin anexos a√∫n</td></tr>
            </tbody>
          </table>
        </div>
        <div class="status" id="filesStatus"></div>
      </section>
    </div>

    <section class="toolbar">
      <div class="bar">
        <button id="btnGuardar" class="btn primary" type="button">Guardar expediente</button>
        <button id="btnWhatsApp" class="btn info" type="button">Enviar WhatsApp</button>
        <button id="btnGenerar" class="btn accent" type="button">Generar PDF</button>
        <button id="btnDemo" class="btn" type="button">Cargar demo</button>
        <button id="btnEliminar" class="btn" type="button" style="border-color:#fecaca;color:#991b1b;background:#fff7f7">Eliminar expediente</button>
      </div>
      <div class="status" id="status"></div>
    </section>
  </main>

  <!-- OVERLAY EXPEDIENTES -->
  <div id="expOverlay" class="overlay" aria-modal="true" role="dialog">
    <div class="ov-header">
      <h3>Expedientes guardados</h3>
      <div class="ov-search">
        <input id="expSearchBox" placeholder="Filtrar por nombre, DNI/CUIT, N¬∫ expediente, car√°tula, juzgado, tipo‚Ä¶" style="flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#ffffff;color:#1f2937">
        <button id="expSearchBtn" class="btn info" type="button">Filtrar</button>
        <button id="expBack" class="btn" type="button">Volver al inicio</button>
      </div>
    </div>
    <div class="ov-body">
      <div class="ov-table">
        <table>
          <thead>
            <tr>
              <th style="width:180px">Persona</th>
              <th style="width:120px">DNI/CUIT</th>
              <th style="width:160px">N¬∫ Expediente</th>
              <th>Car√°tula</th>
              <th style="width:120px">Tipo</th>
              <th style="width:160px">Juzgado</th>
              <th style="width:120px">Actualizado</th>
              <th style="width:80px">Abrir</th>
            </tr>
          </thead>
          <tbody id="expTableBody">
            <tr><td colspan="8" class="muted" style="text-align:center;padding:14px">No hay expedientes a√∫n.</td></tr>
          </tbody>
        </table>
      </div>
      <div class="status" id="expCount"></div>
    </div>
  </div>

  <!-- BOT√ìN VOZ -->
  <button id="voiceFab" class="voice-fab" type="button" title="Dictar por voz">üé§ Dictar</button>

  <!-- TOAST -->
  <div id="toast" class="toast"><span class="ico" id="toastIco">‚úî</span><span id="toastTxt">Ok</span></div>

  <!-- pdf-lib -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script>
    /* ========= UTILIDADES ========= */
    const $ = (id)=>document.getElementById(id);
    const toast = (msg, kind='ok')=>{
      const t=$('toast'), ico=$('toastIco'), txt=$('toastTxt');
      t.classList.remove('ok','err'); t.classList.add(kind==='ok'?'ok':(kind==='err'?'err':'')); 
      ico.textContent = kind==='ok'?'‚úî':(kind==='err'?'‚úñ':'‚Ñπ');
      txt.textContent=msg; t.classList.add('show');
      clearTimeout(t._h); t._h=setTimeout(()=>t.classList.remove('show'),2600);
    };
    const escapeHtml=s=> (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    async function ensurePdfLib(){
      if (window.PDFLib) return;
      await new Promise((resolve,reject)=>{
        const s1=document.createElement('script');
        s1.src='https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js';
        s1.onload=resolve; s1.onerror=reject; document.head.appendChild(s1);
      });
      if(!window.PDFLib) throw new Error('No se pudo cargar pdf-lib');
    }

    /* ========= ESTADO / DB ========= */
    const state = { anexos: [], currentExpId: null, currentPersonaId: null, signatureDataUrl: null, signatureName: '' };

    const dbp = new Promise((resolve,reject)=>{
      const req = indexedDB.open('jab_db', 7);
      req.onupgradeneeded = ()=>{
        const db = req.result;
        if(!db.objectStoreNames.contains('personas')){
          const p = db.createObjectStore('personas', { keyPath:'id' });
          p.createIndex('doc','doc',{unique:true});
          p.createIndex('nombreLower','nombreLower',{unique:false});
        }
        if(!db.objectStoreNames.contains('expedientes')){
          const ex = db.createObjectStore('expedientes', { keyPath:'id' });
          ex.createIndex('personaId','personaId',{unique:false});
          ex.createIndex('updatedAt','updatedAt',{unique:false});
        }
      };
      req.onsuccess=()=>resolve(req.result);
      req.onerror=()=>reject(req.error);
    });

    const withStore = async (name, mode, work)=> new Promise(async (res,rej)=>{
      const db = await dbp;
      const tx = db.transaction(name, mode);
      const store = tx.objectStore(name);
      work(store, tx);
      tx.oncomplete = ()=>res(true);
      tx.onerror = ()=>rej(tx.error);
    });
    const idbPut = (name, val)=> withStore(name,'readwrite', s=>{ s.put(val); });
    const idbDel = (name, key)=> withStore(name,'readwrite', s=>{ s.delete(key); });
    const idbGet = (name, key)=> new Promise(async (res,rej)=>{
      const db = await dbp; const tx = db.transaction(name,'readonly'); const s = tx.objectStore(name);
      const r = s.get(key); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error);
    });
    const idbGetAll = (name)=> new Promise(async (res,rej)=>{
      const db = await dbp; const tx = db.transaction(name,'readonly'); const s = tx.objectStore(name);
      const r = s.getAll ? s.getAll() : s.openCursor();
      if (s.getAll){ r.onsuccess=()=>res(r.result||[]); r.onerror=()=>rej(r.error); }
      else {
        const out=[]; r.onsuccess=()=>{const c=r.result; if(c){ out.push(c.value); c.continue(); } else res(out); };
      }
    });

    const savePersona = async (persona)=> idbPut('personas', persona);
    const getPersonaById = async (id)=> idbGet('personas', id);
    const searchPersonas = async (q)=>{
      q=(q||'').trim().toLowerCase(); if(!q) return [];
      const all=await idbGetAll('personas');
      return all.filter(p=> (p.doc||'').toLowerCase().includes(q) || (p.nombreLower||'').includes(q)).slice(0,200);
    };

    const saveExpediente = async (exp)=> idbPut('expedientes', exp);
    const getExpedientesByPersona = async (personaId)=>{
      const all = await idbGetAll('expedientes');
      return all.filter(e=> e.personaId===personaId);
    };
    const getExpedienteById = async (id)=> idbGet('expedientes', id);
    const getAllExpedientes = async ()=> idbGetAll('expedientes');
    const deleteExpediente = async (id)=> idbDel('expedientes', id);

    /* ========= ARCHIVOS / ANEXOS (UI SIMPLE) ========= */
    $('btnAddFiles').addEventListener('click', ()=> $('fileInput').click());
    $('fileInput').addEventListener('change', (e)=>{
      const files=Array.from(e.target.files||[]);
      files.forEach(f=> state.anexos.push({file:f}));
      e.target.value=''; renderAnexos();
    });
    $('btnClearFiles').addEventListener('click', ()=>{ state.anexos=[]; renderAnexos(); });

    function baseName(name){ const dot=name.lastIndexOf('.'); return dot>0? name.slice(0,dot):name; }
    function extOf(name){ return (name.split('.').pop()||'').toLowerCase(); }
    function fmtSize(bytes){ if(bytes<1024) return bytes+' B'; const kb=bytes/1024; if(kb<1024) return kb.toFixed(1)+' KB'; const mb=kb/1024; return mb.toFixed(2)+' MB'; }

    function renderAnexos(){
      const tbody=$('anexosBody'); tbody.innerHTML='';
      if(state.anexos.length===0){
        tbody.innerHTML='<tr><td colspan="3" class="muted" style="text-align:center;padding:12px">Sin anexos a√∫n</td></tr>';
        $('filesStatus').textContent=''; return;
      }
      state.anexos.forEach((it,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class="file-cell" title="${it.file.name}">${it.file.name}</td>
          <td class="right">${fmtSize(it.file.size)}</td>
          <td>
            <button class="btn small" type="button" data-idx="${idx}" data-act="del" style="background:#fff7f7;border-color:#fecaca;color:#991b1b">Eliminar</button>
          </td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('button[data-act="del"]').forEach(btn=>
        btn.addEventListener('click',()=>{ const i=+btn.dataset.idx; state.anexos.splice(i,1); renderAnexos(); })
      );
      const total=state.anexos.reduce((a,b)=>a+b.file.size,0);
      $('filesStatus').textContent=`${state.anexos.length} anexo(s) ‚Äî ${fmtSize(total)} totales`;
    }

    /* ========= FIRMA DIGITAL ========= */
    const sigPop=$('sigPop'), btnSigOpen=$('btnSigOpen'), sigClose=$('sigClose');
    const sigCanvas=$('sigCanvas'), sigNombre=$('sigNombre'), sigMini=$('sigMini'), sigTxt=$('sigTxt');
    const sigClear=$('sigClear'), sigSave=$('sigSave');
    const sigCtx=sigCanvas.getContext('2d');

    const resizeSig=()=>{
      const dpr=window.devicePixelRatio||1;
      sigCanvas.width=sigCanvas.clientWidth*dpr;
      sigCanvas.height=sigCanvas.clientHeight*dpr;
      sigCtx.setTransform(dpr,0,0,dpr,0,0);
      sigCtx.fillStyle='#ffffff'; sigCtx.fillRect(0,0,sigCanvas.clientWidth,sigCanvas.clientHeight);
      sigCtx.strokeStyle='#1e3a8a'; sigCtx.lineWidth=2;
    };
    window.addEventListener('resize', ()=>{ if(sigPop.classList.contains('show')) resizeSig(); });

    let drawing=false, last={x:0,y:0};
    function pos(e){ const r=sigCanvas.getBoundingClientRect(); const t=e.touches? e.touches[0]: e; return {x:t.clientX-r.left, y:t.clientY-r.top}; }
    function start(e){ drawing=true; last=pos(e); }
    function move(e){ if(!drawing) return; const p=pos(e); sigCtx.beginPath(); sigCtx.moveTo(last.x,last.y); sigCtx.lineTo(p.x,p.y); sigCtx.stroke(); last=p; }
    function end(){ drawing=false; }

    function openSig(){
      sigPop.classList.add('show');
      setTimeout(()=>{
        resizeSig();
        const stored = state.signatureDataUrl||localStorage.getItem('jab.signatureDataUrl');
        if(stored){
          const img=new Image();
          img.onload=()=>{ sigCtx.drawImage(img,10,10,sigCanvas.clientWidth-20,sigCanvas.clientHeight-20); };
          img.src=stored;
        }
      },0);
      sigNombre.value = state.signatureName||localStorage.getItem('jab.signatureName')||'';
    }
    function closeSig(){ sigPop.classList.remove('show'); }

    sigCanvas.addEventListener('mousedown', start); sigCanvas.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
    sigCanvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); start(e); });
    sigCanvas.addEventListener('touchmove', (e)=>{ e.preventDefault(); move(e); });
    sigCanvas.addEventListener('touchend', (e)=>{ e.preventDefault(); end(); });

    sigClear.addEventListener('click', ()=>{ sigCtx.clearRect(0,0,sigCanvas.clientWidth,sigCanvas.clientHeight); resizeSig(); });
    sigSave.addEventListener('click', ()=>{
      state.signatureDataUrl = sigCanvas.toDataURL('image/png');
      state.signatureName = sigNombre.value||'';
      localStorage.setItem('jab.signatureDataUrl', state.signatureDataUrl);
      localStorage.setItem('jab.signatureName', state.signatureName);
      updateSigChip();
      closeSig();
      toast('Firma guardada','ok');
    });
    btnSigOpen.addEventListener('click', openSig);
    sigClose.addEventListener('click', closeSig);

    function updateSigChip(){
      const dataUrl = state.signatureDataUrl || localStorage.getItem('jab.signatureDataUrl');
      const name = state.signatureName || localStorage.getItem('jab.signatureName') || '';
      if(dataUrl){ sigMini.style.backgroundImage = `url(${dataUrl})`; sigTxt.textContent = name? `Firma: ${name}`: 'Firma guardada'; }
      else { sigMini.style.backgroundImage='none'; sigTxt.textContent='Sin firma'; }
    }
    (function initSignature(){
      state.signatureDataUrl = localStorage.getItem('jab.signatureDataUrl');
      state.signatureName = localStorage.getItem('jab.signatureName')||'';
      updateSigChip();
    })();

    /* ========= GUARDAR / CARGAR ========= */
    $('btnGuardar').addEventListener('click', async ()=>{
      try{
        const persona=collectPersona();
        if(!persona.id){ toast('Ingres√° DNI/CUIT del cliente','err'); return; }

        const anexosPacked=await Promise.all(state.anexos.map(async a=>({
          name:a.file.name,type:a.file.type,size:a.file.size,bytes:await a.file.arrayBuffer()
        })));

        const exp=collectExpediente();
        exp.id=exp.id || `exp-${Date.now()}`;
        exp.personaId=persona.id;
        exp.updatedAt=Date.now();
        exp.anexos=anexosPacked;
        exp.sig=state.signatureDataUrl||localStorage.getItem('jab.signatureDataUrl')||null;
        exp.sigNombre=state.signatureName||localStorage.getItem('jab.signatureName')||'';

        await savePersona(persona);
        await saveExpediente(exp);

        state.currentExpId=exp.id; state.currentPersonaId=persona.id;
        $('status').textContent=`Guardado: ${exp.id}`;
        toast('‚úÖ Expediente guardado','ok');
        clearAllForms(false);
        if($('expOverlay').classList.contains('show')) renderOverlayTable();
      }catch(err){
        console.error(err);
        toast('Error al guardar','err');
        $('status').textContent=err?.message||'Error';
      }
    });

    $('btnEliminar').addEventListener('click', async ()=>{
      if(!state.currentExpId){ toast('No hay expediente cargado','err'); return;}
      await deleteExpediente(state.currentExpId);
      toast('Expediente eliminado','ok');
      $('status').textContent='Expediente eliminado';
      clearAllForms(false);
      if($('expOverlay').classList.contains('show')) renderOverlayTable();
    });

    function collectPersona(){
      const id=($('cli_doc').value||'').trim();
      return { id, doc:id, nombre:$('cli_nombre').value.trim(),
        nombreLower:($('cli_nombre').value||'').trim().toLowerCase(),
        dom:$('cli_dom').value.trim(), contacto:$('cli_contacto').value.trim(), updatedAt:Date.now()
      };
    }
    function collectExpediente(){
      return { id:state.currentExpId, tipo:$('exp_tipo').value.trim(), juzgado:$('exp_juzgado').value.trim(),
        numero:$('exp_num').value.trim(), caratula:$('exp_caratula').value.trim(),
        fecha:$('exp_fecha').value || new Date().toISOString().slice(0,10), obs:$('exp_obs').value.trim()
      };
    }
    function fillPersona(p){ if(!p) return; $('cli_doc').value=p.doc||''; $('cli_nombre').value=p.nombre||''; $('cli_dom').value=p.dom||''; $('cli_contacto').value=p.contacto||''; }
    function fillExpediente(exp){ if(!exp) return; state.currentExpId=exp.id; $('exp_tipo').value=exp.tipo||''; $('exp_juzgado').value=exp.juzgado||''; $('exp_num').value=exp.numero||''; $('exp_caratula').value=exp.caratula||''; $('exp_fecha').value=exp.fecha||''; $('exp_obs').value=exp.obs||''; }
    function clearExpedienteForm(){ state.currentExpId=null; $('exp_tipo').value=''; $('exp_juzgado').value=''; $('exp_num').value=''; $('exp_caratula').value=''; $('exp_fecha').value=''; $('exp_obs').value=''; }
    function clearPersonaForm(){ $('cli_doc').value=''; $('cli_nombre').value=''; $('cli_dom').value=''; $('cli_contacto').value=''; }
    function clearAllForms(resetSignature){
      clearPersonaForm(); clearExpedienteForm(); state.anexos=[]; renderAnexos();
      if(resetSignature){
        localStorage.removeItem('jab.signatureDataUrl'); localStorage.removeItem('jab.signatureName');
        state.signatureDataUrl=null; state.signatureName=''; updateSigChip();
      }
      window.scrollTo({top:0,behavior:'smooth'});
    }
    $('btnNuevoExp').addEventListener('click', ()=>{ clearAllForms(false); $('status').textContent='Nuevo expediente listo'; toast('Formulario limpio','ok'); });

    function newFromPacked(ax){ const blob=new Blob([ax.bytes],{type:ax.type}); const f=new File([blob], ax.name,{type:ax.type}); return {file:f}; }

    /* ========= OVERLAY ========= */
    const overlay=$('expOverlay'), expTableBody=$('expTableBody');
    function openExpOverlay(){ overlay.classList.add('show'); renderOverlayTable(); }
    function closeExpOverlay(){ overlay.classList.remove('show'); }
    $('btnListExp').addEventListener('click', openExpOverlay);
    $('expBack').addEventListener('click', ()=>{ closeExpOverlay(); window.scrollTo({top:0,behavior:'smooth'}); });

    $('expSearchBtn').addEventListener('click', renderOverlayTable);
    $('expSearchBox').addEventListener('input', ()=>{ if($('expSearchBox').value.trim().length===0) renderOverlayTable(); });

    async function renderOverlayTable(){
      let items = await getAllExpedientes();
      const term = ($('expSearchBox').value||'').trim().toLowerCase();
      const personasCache = {};
      for(const e of items){
        if(!personasCache[e.personaId]) personasCache[e.personaId] = await getPersonaById(e.personaId);
      }
      const filterMatch = (e)=>{
        if(!term) return true;
        const p = personasCache[e.personaId]||{};
        const hay = [p.nombre||'', p.doc||'', e.numero||'', e.caratula||'', e.juzgado||'', e.tipo||''].join(' ').toLowerCase();
        return hay.includes(term);
      };
      items = items.filter(filterMatch);
      items.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0) );

      expTableBody.innerHTML='';
      if(items.length===0){
        expTableBody.innerHTML='<tr><td colspan="8" class="muted" style="text-align:center;padding:14px">No se encontraron expedientes.</td></tr>';
        $('expCount').textContent='0 resultados'; return;
      }
      for(const e of items){
        const p = personasCache[e.personaId]||{};
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(p.nombre||'(Sin nombre)')}</td>
          <td>${escapeHtml(p.doc||'-')}</td>
          <td>${escapeHtml(e.numero||e.id)}</td>
          <td>${escapeHtml(e.caratula||'-')}</td>
          <td>${escapeHtml(e.tipo||'-')}</td>
          <td>${escapeHtml(e.juzgado||'-')}</td>
          <td>${formatDateTime(e.updatedAt)}</td>
          <td><button class="btn small" type="button" data-open="${e.id}">Abrir</button></td>`;
        expTableBody.appendChild(tr);
      }
      $('expCount').textContent = `${items.length} expediente(s)`;
      expTableBody.querySelectorAll('button[data-open]').forEach(btn=> btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-open'); const exp = await getExpedienteById(id); if(!exp) return;
        const persona = await getPersonaById(exp.personaId);
        fillPersona(persona); fillExpediente(exp);
        state.anexos=(exp.anexos||[]).map(ax=>newFromPacked(ax)); renderAnexos();
        state.currentPersonaId=exp.personaId; state.currentExpId=exp.id;
        toast('Expediente cargado','ok');
        closeExpOverlay();
        window.scrollTo({top:0,behavior:'smooth'});
      }));
    }
    function formatDateTime(ts){
      try{ const d=new Date(ts); const pad=n=>String(n).padStart(2,'0');
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }catch{ return '-'; }
    }

    /* ========= B√öSQUEDA TOPBAR ========= */
    const resultsBox = $('searchResults');
    const showResults = (items)=>{
      resultsBox.innerHTML='';
      if(items.length===0){ resultsBox.classList.remove('show'); return; }
      items.forEach(p=>{
        const div=document.createElement('div'); div.className='result-item';
        div.innerHTML = `<div class="r-avatar">${(p.nombre||'').split(' ').map(s=>s[0]).join('').slice(0,2) || 'H'}</div>
                         <div><div style="font-weight:700">${p.nombre||'(Sin nombre)'}</div>
                         <div class="r-meta">DNI/CUIT: ${p.doc||'-'}</div></div>`;
        div.addEventListener('click', async ()=>{
          resultsBox.classList.remove('show'); fillPersona(p); state.currentPersonaId=p.id;
          const exps=await getExpedientesByPersona(p.id);
          if(exps.length){
            exps.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0) );
            const exp=exps[0]; fillExpediente(exp);
            state.anexos=(exp.anexos||[]).map(ax=>newFromPacked(ax)); renderAnexos();
            state.currentExpId=exp.id; toast('Persona cargada','ok');
            window.scrollTo({top:0,behavior:'smooth'});
          }
        });
        resultsBox.appendChild(div);
      });
      resultsBox.classList.add('show');
    };
    $('btnSearch').addEventListener('click', async ()=>{ const q=$('searchBox').value; showResults(await searchPersonas(q)); });
    $('searchBox').addEventListener('input', async ()=>{
      const q=$('searchBox').value; if(q.trim().length<2){ resultsBox.classList.remove('show'); return; }
      showResults(await searchPersonas(q));
    });
    document.addEventListener('click', (e)=>{ if(!resultsBox.contains(e.target) && e.target!==$('searchBox')) resultsBox.classList.remove('show'); });

    /* ========= CONTACTO S√ìLO N√öMEROS ========= */
    const contactInput = $('cli_contacto');
    contactInput.addEventListener('input', ()=>{
      const digits = contactInput.value.replace(/\D/g,'');
      contactInput.value = digits;
    });

    /* ========= WHATSAPP ========= */
    $('btnWhatsApp').addEventListener('click', ()=>{
      const persona=collectPersona(); const exp=collectExpediente();
      const phone = getCleanPhone(($('cli_contacto').value||''));
      if(!phone){ toast('Ingres√° un celular v√°lido con c√≥digo pa√≠s (ej: 549261...)','err'); return; }
      const mensaje = composeWhatsApp(persona, exp);
      openWhatsApp(phone, mensaje);
    });
    function getCleanPhone(raw){
      const only = (raw||'').replace(/\D/g,'');
      return (only.length >= 10) ? only : null;
    }
    function composeWhatsApp(p, e){
      const estudio = 'Hugo Alonso Batistini';
      return `Estimado/a ${p.nombre||''},\n\nLe contactamos de *${estudio}*. Registramos su demanda${e.tipo? ' ('+e.tipo+')':''}.\n\n*Expediente:* ${e.numero||'-'}\n*Car√°tula:* ${e.caratula||'-'}\n*Juzgado:* ${e.juzgado||'-'}\n*Fecha:* ${e.fecha||new Date().toISOString().slice(0,10)}\n\nPr√≥ximos pasos: nos comunicaremos ante cualquier novedad o requerimiento.\n\nSaludos cordiales.`;
    }
    function openWhatsApp(phone, text){
      const waDeep = `whatsapp://send?phone=${phone}&text=${encodeURIComponent(text)}`;
      const waWeb  = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      if(isMobile){
        location.href = waDeep;
        setTimeout(()=>{ window.open(waWeb,'_blank') || (location.href = waWeb); }, 900);
      }else{
        const win = window.open(waWeb,'_blank');
        if(!win){ location.href = waWeb; }
      }
    }

    /* ========= DEMO ========= */
    $('btnDemo').addEventListener('click', async ()=>{
      const makeImg=async (label)=>{
        const cnv=document.createElement('canvas'); cnv.width=1000; cnv.height=1414; const cx=cnv.getContext('2d');
        cx.fillStyle='#ffffff'; cx.fillRect(0,0,cnv.width,cnv.height);
        cx.fillStyle='#3b82f6'; cx.fillRect(0,0,cnv.width,88);
        cx.fillStyle='#f59e0b'; cx.fillRect(0,1320,cnv.width,14);
        cx.fillStyle='#1f2937'; cx.font='bold 48px Arial'; cx.fillText(label, 40, 140);
        cx.font='24px Arial'; cx.fillText('Documento de muestra ‚Äî Estudio HAB', 40, 200);
        const blob=await new Promise(r=>cnv.toBlob(r,'image/png'));
        return new File([await blob.arrayBuffer()], `${label}.png`, {type:'image/png'});
      };
      await ensurePdfLib();
      const { PDFDocument }=PDFLib;
      const img1=await makeImg('DNI Frente'); const img2=await makeImg('DNI Dorso');
      const d=await PDFDocument.create(); d.addPage([595.28,841.89]); const bytes=await d.save();
      const pdfFile=new File([bytes],'Escrito_Demanda.pdf',{type:'application/pdf'});
      $('cli_nombre').value='Juan P√©rez'; $('cli_doc').value='30123456'; $('cli_dom').value='Sarmiento 123, Maip√∫, Mendoza';
      $('cli_contacto').value='5492615555555';
      $('exp_tipo').value='Laboral'; $('exp_juzgado').value='Juzgado Laboral 5¬∫';
      $('exp_num').value='12345/2025'; $('exp_caratula').value='P√©rez, Juan c/ Empresa SA s/ Despido';
      $('exp_fecha').value=(new Date()).toISOString().slice(0,10);
      $('exp_obs').value='Solicita indemnizaci√≥n por despido sin causa. Se adjunta documentaci√≥n respaldatoria.';
      state.anexos=[{file:img1},{file:img2},{file:pdfFile}];
      renderAnexos(); toast('Demo cargada','ok'); window.scrollTo({top:0,behavior:'smooth'});
    });

    /* ========= GENERAR PDF ========= */
    $('btnGenerar').addEventListener('click', async ()=>{
      try{
        if(state.anexos.length===0){ toast('Agreg√° al menos un anexo','err'); return; }
        await ensurePdfLib();
        const { PDFDocument, StandardFonts, rgb } = PDFLib;

        $('status').textContent='Generando PDF‚Ä¶';
        const pre=[], errores=[];
        for(const it of state.anexos){
          const ex=extOf(it.file.name);
          if(ex==='pdf'){
            try{
              const bytes=await it.file.arrayBuffer();
              const src=await PDFDocument.load(bytes);
              pre.push({type:'pdf',title:baseName(it.file.name),src,pageCount:src.getPageCount()});
            }catch(e){
              console.error('PDF inv√°lido:', it.file.name, e);
              errores.push(it.file.name);
            }
          } else if(['png','jpg','jpeg'].includes(ex)){
            pre.push({type:'img',title:baseName(it.file.name),file:it.file,pageCount:1});
          }
        }
        if(pre.length===0){ toast('No se pudo procesar ning√∫n anexo','err'); return; }
        if(errores.length){ toast('Algunos PDFs no se pudieron leer (ver consola)', 'err'); }

        const A4=[595.28,841.89], margin=50, lineH=14;
        const master=await PDFDocument.create();
        const font=await master.embedFont(StandardFonts.TimesRoman);
        const fontBold=await master.embedFont(StandardFonts.TimesRomanBold);
        const colPrimary=rgb(0x1e/255,0x3a/255,0x8a/255), colGold=rgb(0xf5/255,0x9e/255,0x0b/255), colText=rgb(0x1f/255,0x29/255,0x37/255), colMuted=rgb(0x6b/255,0x72/255,0x80/255);

        // Car√°tula
        const cover=master.addPage(A4);
        cover.drawText('Hugo Alonso Batistini',{x:margin,y:A4[1]-margin-24,size:20,font:fontBold,color:colPrimary});
        cover.drawText('Estudio Jur√≠dico',{x:margin,y:A4[1]-margin-44,size:12,font:font,color:colGold});
        cover.drawLine({start:{x:margin,y:A4[1]-margin-74},end:{x:A4[0]-margin,y:A4[1]-margin-74},thickness:1,color:colPrimary});

        let y=A4[1]-margin-100;
        const f=(label,val)=>{ cover.drawText(label,{x:margin,y,size:12,font:fontBold,color:colMuted}); cover.drawText(val||'-',{x:margin+160,y,size:12,font:font,color:colText}); y-=18; };
        cover.drawText('CAR√ÅTULA DE EXPEDIENTE',{x:margin,y:y,size:16,font:fontBold,color:colPrimary}); y-=24;
        f('Cliente:', $('cli_nombre').value.trim());
        f('DNI/CUIT:', $('cli_doc').value.trim());
        f('Domicilio:', $('cli_dom').value.trim());
        f('Contacto:', $('cli_contacto').value.trim()); y-=8;
        f('Tipo de Demanda:', $('exp_tipo').value.trim());
        f('Juzgado:', $('exp_juzgado').value.trim());
        f('N¬∞ de Expediente:', $('exp_num').value.trim());
        f('Car√°tula:', $('exp_caratula').value.trim());
        f('Fecha:', $('exp_fecha').value || new Date().toISOString().slice(0,10));
        y-=8;
        cover.drawText('Observaciones:',{x:margin,y,size:12,font:fontBold,color:colMuted}); y-=16;
        y = drawWrapped(cover, ($('exp_obs').value||'‚Äî').trim(), {x:margin,y,w:A4[0]-margin*2,lineH:14,font,size:12,color:colText});

        // Firma (opcional)
        const sigData = state.signatureDataUrl||localStorage.getItem('jab.signatureDataUrl');
        const sigName = state.signatureName||localStorage.getItem('jab.signatureName')||'';
        if(sigData){
          const sigBytes=dataURLtoUint8(sigData);
          const sigImg=await master.embedPng(sigBytes);
          const sigW=160, sigH=60;
          cover.drawText('Firmado digitalmente por:',{x:A4[0]-margin- sigW -10, y:150, size:10, font:font, color:colMuted});
          cover.drawImage(sigImg,{x:A4[0]-margin- sigW, y:80, width:sigW, height:sigH});
          cover.drawText(sigName||'HAB ‚Äî Estudio Jur√≠dico',{x:A4[0]-margin- sigW, y:70, size:10, font:font, color:colText});
        }

        // √çndice
        const linesPerPage=Math.floor((A4[1]-margin*2-40)/lineH);
        const indexPagesNeeded=Math.max(1, Math.ceil(pre.length/linesPerPage));
        const startPageAnnex=1+indexPagesNeeded;
        let running=startPageAnnex; const startPages=[];
        pre.forEach(it=>{ startPages.push(running); running+=it.pageCount; });

        let idx=0;
        for(let p=0;p<indexPagesNeeded;p++){
          const page=master.addPage(A4);
          page.drawText('√çNDICE DE ANEXOS',{x:margin,y:A4[1]-margin-24,size:16,font:fontBold,color:colPrimary});
          let iy=A4[1]-margin-50;
          for(let l=0;l<linesPerPage && idx<pre.length;l++){
            const item=pre[idx]; const title=`${idx+1}. ${item.title}`; const pn=startPages[idx];
            page.drawText(title,{x:margin,y:iy,size:12,font:font,color:colText});
            const m=font.widthOfTextAtSize(String(pn),12);
            page.drawText(String(pn),{x:A4[0]-margin-m,y:iy,size:12,font:fontBold,color:colPrimary});
            iy-=lineH; idx++;
          }
        }

                // Anexos
        for (const item of pre) {
          if (item.type === 'pdf') {
            const pages = await master.copyPages(item.src, item.src.getPageIndices());
            pages.forEach(p => master.addPage(p));
          } else {
            const bytes = await item.file.arrayBuffer();
            const page = master.addPage(A4);
            const img = (extOf(item.file.name) === 'png') ? await master.embedPng(bytes) : await master.embedJpg(bytes);
            const maxW = A4[0] - margin * 2, maxH = A4[1] - margin * 2 - 20;
            const s = Math.min(maxW / img.width, maxH / img.height);
            const w = img.width * s, h = img.height * s;
            page.drawText(`Anexo: ${item.title}`, { x: margin, y: A4[1] - margin - 16, size: 11, font: font, color: colMuted });
            page.drawImage(img, { x: (A4[0] - w) / 2, y: (A4[1] - h) / 2 - 10, width: w, height: h });
          }
        }

        // Footer
        const pages = master.getPages(); 
        const total = pages.length; 
        const today = new Date().toISOString().slice(0,10);
        pages.forEach((p,i)=>{
          p.drawLine({ start:{x:margin,y:30}, end:{x:A4[0]-margin,y:30}, thickness:.5, color:colPrimary });
          const left = 'Hugo Alonso Batistini ‚Äî Confidencial';
          const right = `P√°gina ${i+1} de ${total}`;
          p.drawText(left, { x: margin, y: 16, size: 10, font: font, color: colMuted });
          const wR = font.widthOfTextAtSize(right,10); 
          p.drawText(right, { x: A4[0]-margin-wR, y: 16, size: 10, font: font, color: colMuted });
          const wD = font.widthOfTextAtSize(today,10); 
          p.drawText(today, { x: (A4[0]-wD)/2, y: 16, size: 10, font: font, color: colMuted });
        });

        // Descargar
        const pdfBytes = await master.save();
        const blob = new Blob([pdfBytes], { type:'application/pdf' });
        const safeDoc = ($('cli_doc').value||'cliente').replace(/\s+/g,'_').replace(/[^\w.-]/g,'');
        const safeNum = ($('exp_num').value||'expediente').replace(/\s+/g,'_').replace(/[^\w.-]/g,'');
        const filename = `HAB_expediente_${safeDoc}_${safeNum}.pdf`;
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); 
        a.href = url; 
        a.download = filename;
        document.body.appendChild(a); 
        a.click(); 
        a.remove();
        setTimeout(()=> URL.revokeObjectURL(url), 60000);

        $('status').textContent='PDF generado con √©xito';
        toast('PDF generado','ok');
      }catch(err){
        console.error(err);
        $('status').textContent='Error generando el PDF';
        toast('Error al generar PDF','err');
      }
    });

    /* ========= AUX PDF ========= */
    function drawWrapped(page, text, {x,y,w,lineH,font,size,color}){
      if(!text) return y; 
      const words = text.split(/\s+/); 
      let line = ''; 
      let cy = y;
      const draw = (s)=>page.drawText(s,{x,y:cy,size,font,color});
      words.forEach((wrd)=>{
        const test = line ? line+' '+wrd : wrd; 
        const width = font.widthOfTextAtSize(test,size);
        if(width > w && line){ 
          draw(line); 
          cy -= lineH; 
          line = wrd; 
        } else { 
          line = test; 
        }
      });
      if(line){ draw(line); cy -= lineH; }
      return cy;
    }

    /* ========= ACCESOS R√ÅPIDOS ========= */
    document.addEventListener('keydown',(e)=>{
      if(e.key==='Escape'){
        if($('expOverlay').classList.contains('show')) overlay.classList.remove('show');
        if($('sigPop').classList.contains('show')) $('sigPop').classList.remove('show');
      }
    });

    // Querystring inicial (opcional)
    const params = new URLSearchParams(location.search); 
    const q = params.get('q');
    if(q){ 
      $('searchBox').value = q; 
      (async()=>{ 
        const rs = await searchPersonas(q); 
        const box = $('searchResults'); 
        if(rs.length) box.classList.add('show'); 
      })(); 
    }

    // Helpers
    function dataURLtoUint8(u){ 
      const b64 = u.split(',')[1]; 
      const bin = atob(b64); 
      const bytes = new Uint8Array(bin.length); 
      for(let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i); 
      return bytes; 
    }
  </script>
</body>
</html>

